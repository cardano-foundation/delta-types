<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- We intentionally specify more constraints than necessary for some exports.</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-redundant-constraints#-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE GADTs #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators #-}</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="annot"><span class="hs-comment">{-|
Copyright   : &#169; 2022-2023 IOHK, 2023-2025 Cardano Foundation
License     : Apache-2.0
Description : Store a value of a given type outside of volatile memory.

'Store' represents a facility for storing one value of a given type.
Typically, this type is a collection type,
for example 'Data.Map.Map'@ @'Integer'@ @'String',
so that we actually stores multiple values.

The key benefit of a 'Store' is that it can store the value
__outside of volatile memory (RAM)__ &#8212;
for example, the value can be stored in a database file on disk,
that is on persistent storage.

* Read-access is done on parts of the value, through a query GADT
  that is an instance of the 'Query' class.
  In this way, we do not need to load the stored value
  fully into volatile memory.
* Updates are incremental and use delta types, see &quot;Data.Delta&quot;.
  In this way, we can modify the persistent storage incrementally.

Conversely, there is no need to use 'Store' if
the value only ever lives in volatile memory
&#8212; in this case, it is much simpler to use a plain Haskell value,
introduced with @let@, @where@, or as a function argument.
-}</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Data.Store.html"><span class="hs-identifier">Data.Store</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Store, definition</span></span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Type</span></span><span>
</span><span id="line-41"></span><span>      </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier">Store</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Properties</span></span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><span class="hs-comment">-- $Properties</span></span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><span class="hs-comment">-- *** Laws: Load and Write</span></span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><span class="hs-comment">-- $LoadWriteLaws</span></span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span>    </span><span class="annot"><span class="hs-comment">-- *** Laws: Update</span></span><span>
</span><span id="line-50"></span><span>    </span><span class="annot"><span class="hs-comment">-- $UpdateLaws</span></span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span>    </span><span class="annot"><span class="hs-comment">-- *** Laws: Query</span></span><span>
</span><span id="line-53"></span><span>    </span><span class="annot"><span class="hs-comment">-- $QueryLaws</span></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span>    </span><span class="annot"><span class="hs-comment">-- *** Monad</span></span><span>
</span><span id="line-56"></span><span>    </span><span class="annot"><span class="hs-comment">-- $StoreMonad</span></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span>    </span><span class="annot"><span class="hs-comment">-- *** updateS, Maybe argument</span></span><span>
</span><span id="line-59"></span><span>    </span><span class="annot"><span class="hs-comment">-- $updateS</span></span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span>    </span><span class="annot"><span class="hs-comment">-- *** loadS, SomeException</span></span><span>
</span><span id="line-62"></span><span>    </span><span class="annot"><span class="hs-comment">-- $EitherSomeException</span></span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Store, functions</span></span><span>
</span><span id="line-65"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Query</span></span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#Query"><span class="hs-identifier">Query</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#Whole"><span class="hs-identifier">Whole</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Constructors</span></span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#SimpleStore"><span class="hs-identifier">SimpleStore</span></a></span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#mkSimpleStore"><span class="hs-identifier">mkSimpleStore</span></a></span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#UpdateStore"><span class="hs-identifier">UpdateStore</span></a></span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#mkUpdateStore"><span class="hs-identifier">mkUpdateStore</span></a></span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#mkQueryStore"><span class="hs-identifier">mkQueryStore</span></a></span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Combinators</span></span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#hoistStore"><span class="hs-identifier">hoistStore</span></a></span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#embedStore"><span class="hs-identifier">embedStore</span></a></span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#pairStores"><span class="hs-identifier">pairStores</span></a></span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#newCachedStore"><span class="hs-identifier">newCachedStore</span></a></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Helpers</span></span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#updateLoad"><span class="hs-identifier">updateLoad</span></a></span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#loadWhenNothing"><span class="hs-identifier">loadWhenNothing</span></a></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Testing</span></span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#embedStore%27"><span class="hs-identifier">embedStore'</span></a></span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#newStore"><span class="hs-identifier">newStore</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#NotInitialized"><span class="hs-identifier">NotInitialized</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#updateSequence"><span class="hs-identifier">updateSequence</span></a></span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Applicative</span></span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">liftA2</span></span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Class.MonadSTM</span></span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">MonadSTM</span></span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">atomically</span></span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">modifyTVar'</span></span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newTVarIO</span></span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readTVar</span></span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readTVarIO</span></span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">retry</span></span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">writeTVar</span></span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Exception</span></span><span>
</span><span id="line-108"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">SomeException</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">toException</span></span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">foldM_</span></span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">join</span></span><span>
</span><span id="line-114"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Class.MonadThrow</span></span><span>
</span><span id="line-116"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">MonadEvaluate</span></span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">MonadMask</span></span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">MonadThrow</span></span><span>
</span><span id="line-119"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">evaluate</span></span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">finally</span></span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mask</span></span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">throwIO</span></span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Delta</span></span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Delta</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Embedding</span></span><span>
</span><span id="line-127"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Embedding'</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Replace</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Delta.Embedding</span></span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">inject</span></span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">project</span></span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Delta.Embedding.Internal</span></span><span>
</span><span id="line-135"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Machine</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Kind</span></span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Type</span></span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Generics</span></span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-operator">(:+:)</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span class="hs-comment">{-------------------------------------------------------------------------------
    Store
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-147"></span><span class="annot"><span class="hs-comment">{- |
A 'Store' is a storage facility for Haskell values of type
@a ~ @'Base'@ da ~ @'World'@ qa@.

Typical use cases are a file or a database on the hard disk.

The purpose of the type parameters is:

* The monad @m@ encapsulates access to the storage space.
* The query type @qa@ represents the specialized queries
  that this store supports.
* The delta type @da@ is used for incremental updates.

If you care about one these aspects, but not the others,
we recommend to use a specialized type synonym
such as 'SimpleStore' or 'UpdateStore'.
-}</span></span><span>
</span><span id="line-164"></span><span class="hs-keyword">data</span><span> </span><span id="Store"><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-var">Store</span></a></span></span><span> </span><span id="local-6989586621679080377"><span class="annot"><a href="#local-6989586621679080377"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679080378"><span class="annot"><a href="#local-6989586621679080378"><span class="hs-identifier hs-type">qa</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679080379"><span class="annot"><a href="#local-6989586621679080379"><span class="hs-identifier hs-type">da</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Store"><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-var">Store</span></a></span></span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-special">{</span><span>
</span><span id="line-166"></span><span>      </span><span class="hs-comment">-- | Load the value from the store into memory, or fail.</span><span>
</span><span id="line-167"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-168"></span><span>      </span><span class="hs-comment">-- This operation can be expensive.</span><span>
</span><span id="line-169"></span><span>      </span><span id="loadS"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; m (Either SomeException (Base da))
</span><a href="Data.Store.html#loadS"><span class="hs-identifier hs-var hs-var">loadS</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679080377"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Base</span></span><span> </span><span class="annot"><a href="#local-6989586621679080379"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>      </span><span class="annot"><span class="hs-comment">-- | Write a value from memory into the store.</span></span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="writeS"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; Base da -&gt; m ()
</span><a href="Data.Store.html#writeS"><span class="hs-identifier hs-var hs-var">writeS</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Base</span></span><span> </span><span class="annot"><a href="#local-6989586621679080379"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080377"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-172"></span><span>      </span><span class="hs-comment">-- | Update the value in the store</span><span>
</span><span id="line-173"></span><span>      </span><span class="hs-comment">-- incrementally by using a 'Delta' type @da@.</span><span>
</span><span id="line-174"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-175"></span><span>      </span><span class="hs-comment">-- For effiency,</span><span>
</span><span id="line-176"></span><span>      </span><span class="hs-comment">-- the first argument may supply the current value in-memory.</span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="updateS"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; Maybe (Base da) -&gt; da -&gt; m ()
</span><a href="Data.Store.html#updateS"><span class="hs-identifier hs-var hs-var">updateS</span></a></span></span><span>
</span><span id="line-178"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Base</span></span><span> </span><span class="annot"><a href="#local-6989586621679080379"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- old value, for performance</span><span>
</span><span id="line-179"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080379"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="hs-comment">-- delta to new value</span><span>
</span><span id="line-180"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080377"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- write new value</span><span>
</span><span id="line-181"></span><span>      </span><span class="hs-comment">-- | Run a specialized 'Query' on the value in the store.</span><span>
</span><span id="line-182"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-183"></span><span>      </span><span class="hs-comment">-- This operation can be less expensive than 'loadS',</span><span>
</span><span id="line-184"></span><span>      </span><span class="hs-comment">-- because the query may not need to load the whole value into memory.</span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="queryS"><span class="annot"><span class="annottext">forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; forall b. qa b -&gt; m b
</span><a href="Data.Store.html#queryS"><span class="hs-identifier hs-var hs-var">queryS</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679080392"><span class="annot"><a href="#local-6989586621679080392"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621679080378"><span class="hs-identifier hs-type">qa</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080392"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080377"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080392"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span class="annot"><span class="hs-comment">{- $Properties
Any implementation of 'Store' is expected to satisfy the __properties__
specified in this section.
We make no attempt at enforcing these properties on the type-level.
However, the module &quot;Test.Store&quot; provides QuickCheck code for these
properties for automated testing.
-}</span></span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span class="hs-comment">-- Note [LoadWriteLaws]</span><span>
</span><span id="line-197"></span><span class="annot"><span class="hs-comment">{- $LoadWriteLaws

The most fundamental operations on a 'Store' are

* 'loadS' &#8212; loads the value contained in the 'Store' into memory.
* 'writeS' &#8212; writes a value from memory into the 'Store'.

These two operations are characterized by the following design:

1. The store __need not contain__ a properly formatted __value__.

    Loading a value from the store may fail, and this is why 'loadS'
    has an 'Either' result.
    For example, if the 'Store' represents
    a file on disk, then the file may corrupted or in an incompatible
    file format when first opened.
    In such a case of failure, the result 'Left'@ (e :: @'SomeException'@)@
    is returned, where the exception @e@ gives more information
    about the failure.

    However, loading a value after writing it should always succeed,
    we have

        &gt; writeS s a &gt;&gt; loadS s  =  pure (Right a)

2. The store is __redundant__.

    Two stores with different internal contents may contain
    the same value of type @a@.
    For example, two files with different whitespace
    may describe the same JSON value.
    In general, loading a value and writing it again may change the
    internal store contents, i.e.

        &gt; loadS s &gt;&gt;= either (\_ -&gt; pure ()) (writeS s)  &#8800;  pure ()
-}</span></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span class="hs-comment">-- Note [UpdateLaws]</span><span>
</span><span id="line-235"></span><span class="annot"><span class="hs-comment">{- $UpdateLaws

In order to update the store content without loading all of it into memory,
'Store' supports the operation

* 'updateS' &#8212; updates the value contained in the 'Store' using a 'Delta' type.

This operation is characterized by the following law:

* Updating a store __commutes with 'apply'__.

    We have

        &gt; updateS s (Just a) da &gt;&gt; loadS s  =  pure $ Right $ apply a da

    However, since the store is redundant, we often have

        &gt; updateS s (Just a) da  &#8800;  writeS s (apply a da)

The combination of 'loadS', 'writeS', 'updateS' has many similarities
with an 'Embedding' of delta types. However, the main difference
is that manipulating a 'Store' involves side effects.
-}</span></span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span class="hs-comment">-- Note [QueryLaws]</span><span>
</span><span id="line-260"></span><span class="annot"><span class="hs-comment">{- $QueryLaws

In order to query parts of the store content
without loading all of it into memory,
'Store' supports the operation

* 'queryS' &#8212; run a specialized 'Query' on the value contained in the 'Store'.

This operation is characterized by the following law:

* Querying a store __commutes with 'query'__:

        &gt;  &#8704;q. query q &lt;$&gt; (loadS s &gt;&gt;= either throw pure)  =  queryS s q
-}</span></span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span class="hs-comment">-- Note [updateS argument]</span><span>
</span><span id="line-276"></span><span class="annot"><span class="hs-comment">{- $updateS

The function 'updateS' applies a delta to the content of the 'Store'.
Depending on the implementation of the 'Store', this operation may
require large parts of the content to be loaded into memory,
which is expensive.
In some use cases such as 'Data.DBVar.DBVar', the value is already available
in memory and can be used for executing the update.
For these cases, the __first argument__ of 'updateS'
__may__ provide the __in-memory value__.
We expect that the following property holds:

&gt;   updateS s Nothing da
&gt; =
&gt;   loadS s &gt;&gt;= \(Right a) -&gt; updateS s (Just a) da

The helper 'loadWhenNothing' is useful for handling this argument.
-}</span></span><span>
</span><span id="line-294"></span><span>
</span><span id="line-295"></span><span class="annot"><span class="hs-comment">{- $StoreMonad

The monad @m@ in 'Store'@ m da@ provides the storage space for the value.
Put differently, we like to think of @m@ as a
'Control.Monad.Trans.State.State' monad whose state contains the value.
However, this monad @m@ could have __additional side effects__
such as exceptions, concurrency, non-determinism, and so on.
We would have to specify how a 'Store' should behave with regards to these
effects, which complicates matters significantly.
(In fact, the equality sign @=@ for the laws above has to be
interpreted &quot;&#8230; equal effects as far as the 'Store' is concerned&quot;.
A proper approach to a specification would involve Hoare logic.)

For simplicity, we now assume that the monad @m@ only has
the effects __state__ and __exceptions__ &#8212;
we make no attempt at specifying how an implementation
should behave for concurrent usage of, say, 'updateS'.
This assumption ensures some composability of the 'Store' abstraction.
However, it also implies that choosing @m ~ @'Control.Monad.STM.STM'
results in specified semantics, whereas choosing @m ~ @'IO' can
result in unspecified behavior.
(TODO: Perhaps create a type class 'MonadSequential' to keep track
of this on the type level?)

More specifically, the interaction between 'Store' functions and
effects are as follows:

* __State__: The laws presented above specify the essentials
of how the store state changes. However, this specification is not complete,
other &quot;expected&quot; rules such as

    &gt; writeS s a &gt;&gt; writeS s b  =  writeS s b

    etc. should also hold.

* __Exceptions__:

    * 'loadS' should not throw a synchronous exception,
      but return 'Left' instead.
    * 'queryS' should throw a synchronous exception iff 'loadS' returns 'Left'.
      Moving the error case into the monad @m@ simplifes the use of this operation.
    * 'writeS' and 'loadS' should not throw synchronous exceptions.
      However, in case they do throw an exception,
      the contents of the 'Store' should be treated as corrupted,
      and 'loadS' should return 'Left' subsequently.

* __Concurrency__: We do not specify behavior under concurrent operation.
    Concurrent access to a 'Store' is a frequent desideratum
    &#8212; but you will have to implement it yourself.

    One design pattern is to use a custom monad @m ~ MyMonad@
    that has a way of executing state changes atomically,

    &gt; atomically :: MyMonad a -&gt; IO a

    Specifically, @atomically@ either applies /all/ state changes,
    or /none/ of the state changes.
    For instance, SQL transactions can be used for this,
    see e.g. &lt;https://www.sqlite.org/lang_transaction.html&gt;.
    Then, you can implement a 'Store'@ MyMonad@ by composing smaller 'Store',
    and use @atomically@ in a scope where you want to use the 'Store'
    rather than implement it.

    Use 'hoistStore'@ atomically@ to map a 'Store'@ MyMonad@
    to a 'Store'@ IO@ where the monad has less atomicity.

* __Non-determinism__ or other effects: Here be dragons.

-}</span></span><span>
</span><span id="line-364"></span><span>
</span><span id="line-365"></span><span class="hs-comment">-- Note [EitherSomeException]</span><span>
</span><span id="line-366"></span><span class="annot"><span class="hs-comment">{- $EitherSomeException

In the __error case__ that the store does not contain a value,
'loadS' returns a 'Left' value of type 'SomeException'.
This type is a disjoint sum of all possible
error types (that is, members of the 'Exception' class).

We could parametrize 'Store' by an additional type parameter @e@ representing
the possible error cases. However, we have opted to explore
a region of the design space where the number of type parameters
is kept to a minimum.

In fact, I would argue that making errors visible on the type level is not
very useful: we add much noise to the type level,
but we gain little type-safety in exchange.
Specifically, if we encounter an element of the 'SomeException' type that
we did not expect, we can always 'throw' it.
For example, consider the following code:

@
let ea :: Either SomeException ()
    ea = [..]
in
    case ea of
        Right _ -&gt; &quot;everything is ok&quot;
        Left e -&gt; case fromException e of
            Just (AssertionFailed _) -&gt; &quot;bad things happened&quot;
            Nothing -&gt; throw e
@

In this example, using the more specific type @ea :: Either AssertionFailed ()@
would have eliminated the 'Nothing' case.
However, this case has the sensible default value:
@throw e@, we rethrow the exception that we did not expect.
Ruling out this case on the type-level adds almost no value.
-}</span></span><span>
</span><span id="line-402"></span><span>
</span><span id="line-403"></span><span class="hs-comment">{-------------------------------------------------------------------------------
    Constructors
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-406"></span><span class="hs-comment">{- HLINT ignore newStore &quot;Use readTVarIO&quot; -}</span><span>
</span><span id="line-407"></span><span class="hs-comment">-- | An in-memory 'Store' from a mutable variable ('TVar').</span><span>
</span><span id="line-408"></span><span class="hs-comment">-- Useful for testing.</span><span>
</span><span id="line-409"></span><span id="local-6989586621679080397"><span id="local-6989586621679080400"><span id="local-6989586621679080402"><span class="annot"><a href="Data.Store.html#newStore"><span class="hs-identifier hs-type">newStore</span></a></span><span>
</span><span id="line-410"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679080397"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621679080397"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Delta</span></span><span> </span><span class="annot"><a href="#local-6989586621679080400"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#Query"><span class="hs-identifier hs-type">Query</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080402"><span class="hs-identifier hs-type">qa</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Base</span></span><span> </span><span class="annot"><a href="#local-6989586621679080400"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Data.Store.html#World"><span class="hs-identifier hs-type">World</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080402"><span class="hs-identifier hs-type">qa</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-411"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080397"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080397"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080402"><span class="hs-identifier hs-type">qa</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080400"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-412"></span><span id="newStore"><span class="annot"><span class="annottext">newStore :: forall (m :: * -&gt; *) da (qa :: * -&gt; *).
(MonadSTM m, MonadThrow m, Delta da, Query qa,
 Base da ~ World qa) =&gt;
m (Store m qa da)
</span><a href="Data.Store.html#newStore"><span class="hs-identifier hs-var hs-var">newStore</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-413"></span><span>    </span><span id="local-6989586621679080663"><span class="annot"><a href="#local-6989586621679080663"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either SomeException (World qa)
-&gt; m (TVar m (Either SomeException (World qa)))
forall a. a -&gt; m (TVar m a)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (TVar m a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">(Either SomeException (World qa)
 -&gt; m (TVar m (Either SomeException (World qa))))
-&gt; Either SomeException (World qa)
-&gt; m (TVar m (Either SomeException (World qa)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Either SomeException (World qa)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; Either SomeException (World qa))
-&gt; SomeException -&gt; Either SomeException (World qa)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NotInitialized -&gt; SomeException
forall e. Exception e =&gt; e -&gt; SomeException
</span><span class="hs-identifier hs-var">toException</span></span><span> </span><span class="annot"><span class="annottext">NotInitialized
</span><a href="Data.Store.html#NotInitialized"><span class="hs-identifier hs-var">NotInitialized</span></a></span><span>
</span><span id="line-414"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679080665"><span class="annot"><a href="#local-6989586621679080665"><span class="hs-identifier hs-var hs-var">load</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m (Either SomeException (World qa))
-&gt; m (Either SomeException (World qa))
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar m (Either SomeException (World qa))
-&gt; STM m (Either SomeException (World qa))
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (Either SomeException (World qa))
</span><a href="#local-6989586621679080663"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-415"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span>
</span><span id="line-416"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Data.Store.html#loadS"><span class="hs-identifier hs-var">loadS</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679080665"><span class="hs-identifier hs-type">load</span></a></span><span>
</span><span id="line-417"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#queryS"><span class="hs-identifier hs-var">queryS</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679080670"><span class="annot"><span class="annottext">qa b
</span><a href="#local-6989586621679080670"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">qa b -&gt; World qa -&gt; b
forall b. qa b -&gt; World qa -&gt; b
forall (qa :: * -&gt; *) b. Query qa =&gt; qa b -&gt; World qa -&gt; b
</span><a href="Data.Store.html#query"><span class="hs-identifier hs-var">query</span></a></span><span> </span><span class="annot"><span class="annottext">qa b
</span><a href="#local-6989586621679080670"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">(World qa -&gt; b) -&gt; m (World qa) -&gt; m b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Either SomeException (World qa) -&gt; m (World qa)
forall (m :: * -&gt; *) b.
MonadThrow m =&gt;
Either SomeException b -&gt; m b
</span><a href="Data.Store.html#throwLeft"><span class="hs-identifier hs-var">throwLeft</span></a></span><span> </span><span class="annot"><span class="annottext">(Either SomeException (World qa) -&gt; m (World qa))
-&gt; m (Either SomeException (World qa)) -&gt; m (World qa)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">m (Either SomeException (World qa))
</span><a href="#local-6989586621679080665"><span class="hs-identifier hs-var">load</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-418"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#writeS"><span class="hs-identifier hs-var">writeS</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">atomically</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">writeTVar</span></span><span> </span><span class="annot"><a href="#local-6989586621679080663"><span class="hs-identifier hs-type">ref</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">.</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span>
</span><span id="line-419"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#updateS"><span class="hs-identifier hs-var">updateS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Maybe (Base da)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; (da -&gt; STM m ()) -&gt; da -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TVar m (Either SomeException (World qa))
-&gt; (Either SomeException (World qa)
    -&gt; Either SomeException (World qa))
-&gt; STM m ()
forall a. TVar m a -&gt; (a -&gt; a) -&gt; STM m ()
forall (m :: * -&gt; *) a.
MonadSTM m =&gt;
TVar m a -&gt; (a -&gt; a) -&gt; STM m ()
</span><span class="hs-identifier hs-var">modifyTVar'</span></span><span> </span><span class="annot"><span class="annottext">TVar m (Either SomeException (World qa))
</span><a href="#local-6989586621679080663"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">((Either SomeException (World qa)
  -&gt; Either SomeException (World qa))
 -&gt; STM m ())
-&gt; (da
    -&gt; Either SomeException (World qa)
    -&gt; Either SomeException (World qa))
-&gt; da
-&gt; STM m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(World qa -&gt; World qa)
-&gt; Either SomeException (World qa)
-&gt; Either SomeException (World qa)
forall a b.
(a -&gt; b) -&gt; Either SomeException a -&gt; Either SomeException b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">((World qa -&gt; World qa)
 -&gt; Either SomeException (World qa)
 -&gt; Either SomeException (World qa))
-&gt; (da -&gt; World qa -&gt; World qa)
-&gt; da
-&gt; Either SomeException (World qa)
-&gt; Either SomeException (World qa)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">da -&gt; Base da -&gt; Base da
da -&gt; World qa -&gt; World qa
forall delta. Delta delta =&gt; delta -&gt; Base delta -&gt; Base delta
</span><span class="hs-identifier hs-var">apply</span></span><span>
</span><span id="line-420"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-421"></span><span>
</span><span id="line-422"></span><span class="annot"><span class="hs-comment">-- | Failure that occurs when calling 'loadS' on a 'newStore' that is empty.</span></span><span>
</span><span id="line-423"></span><span class="hs-keyword">data</span><span> </span><span id="NotInitialized"><span class="annot"><a href="Data.Store.html#NotInitialized"><span class="hs-identifier hs-var">NotInitialized</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="NotInitialized"><span class="annot"><a href="Data.Store.html#NotInitialized"><span class="hs-identifier hs-var">NotInitialized</span></a></span></span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679080676"><span id="local-6989586621679080678"><span class="annot"><span class="annottext">NotInitialized -&gt; NotInitialized -&gt; Bool
(NotInitialized -&gt; NotInitialized -&gt; Bool)
-&gt; (NotInitialized -&gt; NotInitialized -&gt; Bool) -&gt; Eq NotInitialized
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: NotInitialized -&gt; NotInitialized -&gt; Bool
== :: NotInitialized -&gt; NotInitialized -&gt; Bool
$c/= :: NotInitialized -&gt; NotInitialized -&gt; Bool
/= :: NotInitialized -&gt; NotInitialized -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679080683"><span id="local-6989586621679080685"><span id="local-6989586621679080689"><span class="annot"><span class="annottext">Int -&gt; NotInitialized -&gt; ShowS
[NotInitialized] -&gt; ShowS
NotInitialized -&gt; String
(Int -&gt; NotInitialized -&gt; ShowS)
-&gt; (NotInitialized -&gt; String)
-&gt; ([NotInitialized] -&gt; ShowS)
-&gt; Show NotInitialized
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; NotInitialized -&gt; ShowS
showsPrec :: Int -&gt; NotInitialized -&gt; ShowS
$cshow :: NotInitialized -&gt; String
show :: NotInitialized -&gt; String
$cshowList :: [NotInitialized] -&gt; ShowS
showList :: [NotInitialized] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-424"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679080698"><span id="local-6989586621679080701"><span id="local-6989586621679080704"><span id="local-6989586621679080707"><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="Data.Store.html#NotInitialized"><span class="hs-identifier hs-type">NotInitialized</span></a></span></span></span></span></span><span>
</span><span id="line-425"></span><span>
</span><span id="line-426"></span><span class="hs-comment">-- | A 'Store' which supports 'loadS' and 'writeS',</span><span>
</span><span id="line-427"></span><span class="hs-comment">-- but no fancy query or update operations.</span><span>
</span><span id="line-428"></span><span class="hs-keyword">type</span><span> </span><span id="SimpleStore"><span class="annot"><a href="Data.Store.html#SimpleStore"><span class="hs-identifier hs-var">SimpleStore</span></a></span></span><span> </span><span id="local-6989586621679080710"><span class="annot"><a href="#local-6989586621679080710"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679080711"><span class="annot"><a href="#local-6989586621679080711"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080710"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Store.html#Whole"><span class="hs-identifier hs-type">Whole</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080711"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Replace</span></span><span> </span><span class="annot"><a href="#local-6989586621679080711"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-429"></span><span>
</span><span id="line-430"></span><span class="hs-comment">-- | @mkSimpleStore loadS writeS@ constructs a 'SimpleStore'</span><span>
</span><span id="line-431"></span><span class="hs-comment">-- from the given operations.</span><span>
</span><span id="line-432"></span><span class="annot"><a href="Data.Store.html#mkSimpleStore"><span class="hs-identifier hs-type">mkSimpleStore</span></a></span><span>
</span><span id="line-433"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679080454"><span class="annot"><a href="#local-6989586621679080454"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679080455"><span class="annot"><a href="#local-6989586621679080455"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-434"></span><span>     </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679080454"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621679080454"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-435"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080454"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span> </span><span class="annot"><a href="#local-6989586621679080455"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-436"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679080455"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080454"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-437"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.html#SimpleStore"><span class="hs-identifier hs-type">SimpleStore</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080454"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080455"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-438"></span><span id="mkSimpleStore"><span class="annot"><span class="annottext">mkSimpleStore :: forall (m :: * -&gt; *) a.
(Monad m, MonadThrow m) =&gt;
m (Either SomeException a) -&gt; (a -&gt; m ()) -&gt; SimpleStore m a
</span><a href="Data.Store.html#mkSimpleStore"><span class="hs-identifier hs-var hs-var">mkSimpleStore</span></a></span></span><span> </span><span id="local-6989586621679080720"><span class="annot"><span class="annottext">m (Either SomeException a)
</span><a href="#local-6989586621679080720"><span class="hs-identifier hs-var">loadS</span></a></span></span><span> </span><span id="local-6989586621679080721"><span class="annot"><span class="annottext">a -&gt; m ()
</span><a href="#local-6989586621679080721"><span class="hs-identifier hs-var">writeS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-439"></span><span>    </span><span class="annot"><span class="annottext">m (Either SomeException a)
-&gt; (a -&gt; m ())
-&gt; (Maybe a -&gt; Replace a -&gt; m ())
-&gt; UpdateStore m (Replace a)
forall (m :: * -&gt; *) a da.
(Monad m, MonadThrow m, a ~ Base da, Delta da) =&gt;
m (Either SomeException a)
-&gt; (a -&gt; m ()) -&gt; (Maybe a -&gt; da -&gt; m ()) -&gt; UpdateStore m da
</span><a href="Data.Store.html#mkUpdateStore"><span class="hs-identifier hs-var">mkUpdateStore</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either SomeException a)
</span><a href="#local-6989586621679080720"><span class="hs-identifier hs-var">loadS</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; m ()
</span><a href="#local-6989586621679080721"><span class="hs-identifier hs-var">writeS</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; Replace a -&gt; m ()
</span><a href="#local-6989586621679080722"><span class="hs-identifier hs-var">update'</span></a></span><span>
</span><span id="line-440"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-441"></span><span>    </span><span id="local-6989586621679080722"><span class="annot"><span class="annottext">update' :: Maybe a -&gt; Replace a -&gt; m ()
</span><a href="#local-6989586621679080722"><span class="hs-identifier hs-var hs-var">update'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Replace</span></span><span> </span><span id="local-6989586621679080724"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679080724"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; m ()
</span><a href="#local-6989586621679080721"><span class="hs-identifier hs-var">writeS</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679080724"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-442"></span><span>
</span><span id="line-443"></span><span class="annot"><span class="hs-comment">-- | A 'Store' whose focus lies on updating the value rather than querying it.</span></span><span>
</span><span id="line-444"></span><span class="hs-keyword">type</span><span> </span><span id="UpdateStore"><span class="annot"><a href="Data.Store.html#UpdateStore"><span class="hs-identifier hs-var">UpdateStore</span></a></span></span><span> </span><span id="local-6989586621679080725"><span class="annot"><a href="#local-6989586621679080725"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679080726"><span class="annot"><a href="#local-6989586621679080726"><span class="hs-identifier hs-type">da</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080725"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Store.html#Whole"><span class="hs-identifier hs-type">Whole</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Base</span></span><span> </span><span class="annot"><a href="#local-6989586621679080726"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679080726"><span class="hs-identifier hs-type">da</span></a></span><span>
</span><span id="line-445"></span><span>
</span><span id="line-446"></span><span class="hs-comment">-- | @mkUpdateStore loadS writeS updateS@ constructs an 'UpdateStore'</span><span>
</span><span id="line-447"></span><span class="hs-comment">-- from the given operations.</span><span>
</span><span id="line-448"></span><span class="annot"><a href="Data.Store.html#mkUpdateStore"><span class="hs-identifier hs-type">mkUpdateStore</span></a></span><span>
</span><span id="line-449"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679080463"><span class="annot"><a href="#local-6989586621679080463"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679080464"><span class="annot"><a href="#local-6989586621679080464"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679080465"><span class="annot"><a href="#local-6989586621679080465"><span class="hs-identifier hs-type">da</span></a></span></span><span>
</span><span id="line-450"></span><span>     </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679080463"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621679080463"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679080464"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Base</span></span><span> </span><span class="annot"><a href="#local-6989586621679080465"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Delta</span></span><span> </span><span class="annot"><a href="#local-6989586621679080465"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-451"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080463"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span> </span><span class="annot"><a href="#local-6989586621679080464"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-452"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679080464"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080463"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-453"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679080464"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080465"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080463"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-454"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.html#UpdateStore"><span class="hs-identifier hs-type">UpdateStore</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080463"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080465"><span class="hs-identifier hs-type">da</span></a></span><span>
</span><span id="line-455"></span><span id="mkUpdateStore"><span class="annot"><span class="annottext">mkUpdateStore :: forall (m :: * -&gt; *) a da.
(Monad m, MonadThrow m, a ~ Base da, Delta da) =&gt;
m (Either SomeException a)
-&gt; (a -&gt; m ()) -&gt; (Maybe a -&gt; da -&gt; m ()) -&gt; UpdateStore m da
</span><a href="Data.Store.html#mkUpdateStore"><span class="hs-identifier hs-var hs-var">mkUpdateStore</span></a></span></span><span> </span><span id="local-6989586621679080733"><span class="annot"><span class="annottext">m (Either SomeException a)
</span><a href="#local-6989586621679080733"><span class="hs-identifier hs-var">loadS</span></a></span></span><span> </span><span id="local-6989586621679080734"><span class="annot"><span class="annottext">a -&gt; m ()
</span><a href="#local-6989586621679080734"><span class="hs-identifier hs-var">writeS</span></a></span></span><span> </span><span id="local-6989586621679080735"><span class="annot"><span class="annottext">Maybe a -&gt; da -&gt; m ()
</span><a href="#local-6989586621679080735"><span class="hs-identifier hs-var">updateS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-456"></span><span>    </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">m (Either SomeException a)
m (Either SomeException (Base da))
loadS :: m (Either SomeException (Base da))
loadS :: m (Either SomeException a)
</span><a href="Data.Store.html#loadS"><span class="hs-identifier hs-var hs-var">loadS</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">queryS :: forall b. Whole a b -&gt; m b
</span><a href="Data.Store.html#queryS"><span class="hs-identifier hs-var">queryS</span></a></span><span class="hs-glyph">=</span><span class="annot"><span class="annottext">Whole a b -&gt; m b
forall b. Whole a b -&gt; m b
</span><a href="#local-6989586621679080736"><span class="hs-identifier hs-var">query'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a -&gt; m ()
Base da -&gt; m ()
writeS :: Base da -&gt; m ()
writeS :: a -&gt; m ()
</span><a href="Data.Store.html#writeS"><span class="hs-identifier hs-var hs-var">writeS</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; da -&gt; m ()
Maybe (Base da) -&gt; da -&gt; m ()
updateS :: Maybe (Base da) -&gt; da -&gt; m ()
updateS :: Maybe a -&gt; da -&gt; m ()
</span><a href="Data.Store.html#updateS"><span class="hs-identifier hs-var hs-var">updateS</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-457"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-458"></span><span>    </span><span class="annot"><a href="#local-6989586621679080736"><span class="hs-identifier hs-type">query'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679080737"><span class="annot"><a href="#local-6989586621679080737"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Data.Store.html#Whole"><span class="hs-identifier hs-type">Whole</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080464"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080737"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080463"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080737"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-459"></span><span>    </span><span id="local-6989586621679080736"><span class="annot"><span class="annottext">query' :: forall b. Whole a b -&gt; m b
</span><a href="#local-6989586621679080736"><span class="hs-identifier hs-var hs-var">query'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Whole a b
</span><a href="Data.Store.html#Whole"><span class="hs-identifier hs-var">Whole</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (Either SomeException a)
</span><a href="#local-6989586621679080733"><span class="hs-identifier hs-var">loadS</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either SomeException a)
-&gt; (Either SomeException a -&gt; m b) -&gt; m b
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Either SomeException a -&gt; m a
Either SomeException a -&gt; m b
forall (m :: * -&gt; *) b.
MonadThrow m =&gt;
Either SomeException b -&gt; m b
</span><a href="Data.Store.html#throwLeft"><span class="hs-identifier hs-var">throwLeft</span></a></span><span>
</span><span id="line-460"></span><span>
</span><span id="line-461"></span><span class="hs-comment">-- | @mkQueryStore queryS store@ constructs a 'Store'</span><span>
</span><span id="line-462"></span><span class="hs-comment">-- from a query and an 'UpdateStore'.</span><span>
</span><span id="line-463"></span><span class="annot"><a href="Data.Store.html#mkQueryStore"><span class="hs-identifier hs-type">mkQueryStore</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679080473"><span class="annot"><a href="#local-6989586621679080473"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679080475"><span class="annot"><a href="#local-6989586621679080475"><span class="hs-identifier hs-type">qa</span></a></span></span><span> </span><span id="local-6989586621679080474"><span class="annot"><a href="#local-6989586621679080474"><span class="hs-identifier hs-type">da</span></a></span></span><span>
</span><span id="line-464"></span><span>     </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621679080473"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Delta</span></span><span> </span><span class="annot"><a href="#local-6989586621679080474"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#Query"><span class="hs-identifier hs-type">Query</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080475"><span class="hs-identifier hs-type">qa</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Base</span></span><span> </span><span class="annot"><a href="#local-6989586621679080474"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Data.Store.html#World"><span class="hs-identifier hs-type">World</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080475"><span class="hs-identifier hs-type">qa</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-465"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679080476"><span class="annot"><a href="#local-6989586621679080476"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621679080475"><span class="hs-identifier hs-type">qa</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080476"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080473"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080476"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-466"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.html#UpdateStore"><span class="hs-identifier hs-type">UpdateStore</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080473"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080474"><span class="hs-identifier hs-type">da</span></a></span><span>
</span><span id="line-467"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080473"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080475"><span class="hs-identifier hs-type">qa</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080474"><span class="hs-identifier hs-type">da</span></a></span><span>
</span><span id="line-468"></span><span id="mkQueryStore"><span class="annot"><span class="annottext">mkQueryStore :: forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
(MonadThrow m, Delta da, Query qa, Base da ~ World qa) =&gt;
(forall b. qa b -&gt; m b) -&gt; UpdateStore m da -&gt; Store m qa da
</span><a href="Data.Store.html#mkQueryStore"><span class="hs-identifier hs-var hs-var">mkQueryStore</span></a></span></span><span> </span><span id="local-6989586621679080746"><span class="annot"><span class="annottext">forall b. qa b -&gt; m b
</span><a href="#local-6989586621679080746"><span class="hs-identifier hs-var">queryS</span></a></span></span><span> </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span class="hs-special">{</span><span id="local-6989586621679080747"><span class="annot"><span class="annottext">m (Either SomeException (Base da))
loadS :: forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; m (Either SomeException (Base da))
loadS :: m (Either SomeException (Base da))
</span><a href="Data.Store.html#loadS"><span class="hs-identifier hs-var hs-var">loadS</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679080748"><span class="annot"><span class="annottext">Base da -&gt; m ()
writeS :: forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; Base da -&gt; m ()
writeS :: Base da -&gt; m ()
</span><a href="Data.Store.html#writeS"><span class="hs-identifier hs-var hs-var">writeS</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679080749"><span class="annot"><span class="annottext">Maybe (Base da) -&gt; da -&gt; m ()
updateS :: forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; Maybe (Base da) -&gt; da -&gt; m ()
updateS :: Maybe (Base da) -&gt; da -&gt; m ()
</span><a href="Data.Store.html#updateS"><span class="hs-identifier hs-var hs-var">updateS</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-469"></span><span>    </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">qa b -&gt; m b
forall b. qa b -&gt; m b
queryS :: forall b. qa b -&gt; m b
queryS :: forall b. qa b -&gt; m b
</span><a href="Data.Store.html#queryS"><span class="hs-identifier hs-var hs-var">queryS</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">m (Either SomeException (Base da))
loadS :: m (Either SomeException (Base da))
loadS :: m (Either SomeException (Base da))
</span><a href="Data.Store.html#loadS"><span class="hs-identifier hs-var hs-var">loadS</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Base da -&gt; m ()
writeS :: Base da -&gt; m ()
writeS :: Base da -&gt; m ()
</span><a href="Data.Store.html#writeS"><span class="hs-identifier hs-var hs-var">writeS</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Maybe (Base da) -&gt; da -&gt; m ()
updateS :: Maybe (Base da) -&gt; da -&gt; m ()
updateS :: Maybe (Base da) -&gt; da -&gt; m ()
</span><a href="Data.Store.html#updateS"><span class="hs-identifier hs-var hs-var">updateS</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-470"></span><span>
</span><span id="line-471"></span><span class="hs-comment">{-------------------------------------------------------------------------------
    Query
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-474"></span><span class="hs-comment">-- | A __query__ @qa b@ for the type @a ~ World qa@</span><span>
</span><span id="line-475"></span><span class="hs-comment">-- corresponds to a function @a -&gt; b@.</span><span>
</span><span id="line-476"></span><span class="hs-comment">-- Put differently, a query allows us to extract some information of type @b@</span><span>
</span><span id="line-477"></span><span class="hs-comment">-- from the larger type @a@.</span><span>
</span><span id="line-478"></span><span class="hs-comment">--</span><span>
</span><span id="line-479"></span><span class="hs-comment">-- Typically, instances of 'Query' are</span><span>
</span><span id="line-480"></span><span class="hs-comment">-- generalized algebraic data types (GADT).</span><span>
</span><span id="line-481"></span><span class="hs-keyword">class</span><span> </span><span id="Query"><span class="annot"><a href="Data.Store.html#Query"><span class="hs-identifier hs-var">Query</span></a></span></span><span> </span><span id="local-6989586621679080433"><span class="annot"><a href="#local-6989586621679080433"><span class="hs-identifier hs-type">qa</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-482"></span><span>    </span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="World"><span class="annot"><a href="Data.Store.html#World"><span class="hs-identifier hs-var">World</span></a></span></span><span> </span><span id="local-6989586621679080433"><span class="annot"><a href="#local-6989586621679080433"><span class="hs-identifier hs-type">qa</span></a></span></span><span>
</span><span id="line-483"></span><span>    </span><span id="query"><span class="annot"><a href="Data.Store.html#query"><span class="hs-identifier hs-type">query</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span id="local-6989586621679080432"><span class="annot"><a href="#local-6989586621679080433"><span class="hs-identifier hs-type">qa</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080432"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.html#World"><span class="hs-identifier hs-type">World</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080433"><span class="hs-identifier hs-type">qa</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080432"><span class="hs-identifier hs-type">b</span></a></span></span><span>
</span><span id="line-484"></span><span>
</span><span id="line-485"></span><span class="annot"><span class="hs-comment">-- | The query that retrieves the whole value.</span></span><span>
</span><span id="line-486"></span><span class="hs-keyword">data</span><span> </span><span id="Whole"><span class="annot"><a href="Data.Store.html#Whole"><span class="hs-identifier hs-var">Whole</span></a></span></span><span> </span><span id="local-6989586621679080750"><span class="annot"><a href="#local-6989586621679080750"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679080751"><span class="annot"><a href="#local-6989586621679080751"><span class="hs-identifier hs-type">b</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-487"></span><span>    </span><span id="local-6989586621679080752"><span id="Whole"><span class="annot"><a href="Data.Store.html#Whole"><span class="hs-identifier hs-var">Whole</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Data.Store.html#Whole"><span class="hs-identifier hs-type">Whole</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080752"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080752"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-488"></span><span>
</span><span id="line-489"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679080482"><span class="annot"><a href="Data.Store.html#Query"><span class="hs-identifier hs-type">Query</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Store.html#Whole"><span class="hs-identifier hs-type">Whole</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080482"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-490"></span><span>    </span><span class="hs-keyword">type</span><span> </span><span id="World"><span class="annot"><a href="Data.Store.html#World"><span class="hs-identifier hs-var">World</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Store.html#Whole"><span class="hs-identifier hs-type">Whole</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080482"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679080482"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-491"></span><span>    </span><span id="local-6989586621679080756"><span class="annot"><span class="annottext">query :: forall b. Whole a b -&gt; World (Whole a) -&gt; b
</span><a href="Data.Store.html#query"><span class="hs-identifier hs-var hs-var hs-var">query</span></a></span></span><span> </span><span class="annot"><span class="annottext">Whole a b
</span><a href="Data.Store.html#Whole"><span class="hs-identifier hs-var">Whole</span></a></span><span> </span><span id="local-6989586621679080758"><span class="annot"><span class="annottext">World (Whole a)
</span><a href="#local-6989586621679080758"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">b
World (Whole a)
</span><a href="#local-6989586621679080758"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span class="hs-comment">{-------------------------------------------------------------------------------
    Combinators
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-496"></span><span class="hs-comment">-- | Add a caching layer to a 'Store'.</span><span>
</span><span id="line-497"></span><span class="hs-comment">--</span><span>
</span><span id="line-498"></span><span class="hs-comment">-- Access to the underlying 'Store' is enforced to be sequential,</span><span>
</span><span id="line-499"></span><span class="hs-comment">-- but the cache can be accessed in parallel.</span><span>
</span><span id="line-500"></span><span class="hs-comment">--</span><span>
</span><span id="line-501"></span><span class="hs-comment">-- FIXME: There is still a small race condition where the cache</span><span>
</span><span id="line-502"></span><span class="hs-comment">-- could be written twice before it is filled. &#129300;</span><span>
</span><span id="line-503"></span><span class="hs-comment">-- TODO: Think about whether it is really necessary to handle concurrency here.</span><span>
</span><span id="line-504"></span><span class="hs-comment">-- I think the answer is &quot;yes&quot;, but only because the mutable variables</span><span>
</span><span id="line-505"></span><span class="hs-comment">-- provided by the monad @m@ do not work together with e.g. SQL transactions.</span><span>
</span><span id="line-506"></span><span class="annot"><a href="Data.Store.html#newCachedStore"><span class="hs-identifier hs-type">newCachedStore</span></a></span><span>
</span><span id="line-507"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679080484"><span class="annot"><a href="#local-6989586621679080484"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621679080487"><span class="annot"><a href="#local-6989586621679080487"><span class="hs-identifier hs-type">qa</span></a></span></span><span> </span><span id="local-6989586621679080486"><span class="annot"><a href="#local-6989586621679080486"><span class="hs-identifier hs-type">da</span></a></span></span><span>
</span><span id="line-508"></span><span>      </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679080484"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621679080484"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadEvaluate</span></span><span> </span><span class="annot"><a href="#local-6989586621679080484"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-509"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Delta</span></span><span> </span><span class="annot"><a href="#local-6989586621679080486"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#Query"><span class="hs-identifier hs-type">Query</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080487"><span class="hs-identifier hs-type">qa</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Base</span></span><span> </span><span class="annot"><a href="#local-6989586621679080486"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Data.Store.html#World"><span class="hs-identifier hs-type">World</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080487"><span class="hs-identifier hs-type">qa</span></a></span><span>
</span><span id="line-510"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-511"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080484"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080487"><span class="hs-identifier hs-type">qa</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080486"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080484"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080484"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080487"><span class="hs-identifier hs-type">qa</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080486"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-512"></span><span id="newCachedStore"><span class="annot"><span class="annottext">newCachedStore :: forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
(MonadSTM m, MonadThrow m, MonadEvaluate m, Delta da, Query qa,
 Base da ~ World qa) =&gt;
Store m qa da -&gt; m (Store m qa da)
</span><a href="Data.Store.html#newCachedStore"><span class="hs-identifier hs-var hs-var">newCachedStore</span></a></span></span><span> </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span class="hs-special">{</span><span id="local-6989586621679080813"><span class="annot"><span class="annottext">m (Either SomeException (Base da))
loadS :: forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; m (Either SomeException (Base da))
loadS :: m (Either SomeException (Base da))
</span><a href="Data.Store.html#loadS"><span class="hs-identifier hs-var hs-var">loadS</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679080814"><span class="annot"><span class="annottext">Base da -&gt; m ()
writeS :: forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; Base da -&gt; m ()
writeS :: Base da -&gt; m ()
</span><a href="Data.Store.html#writeS"><span class="hs-identifier hs-var hs-var">writeS</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679080815"><span class="annot"><span class="annottext">Maybe (Base da) -&gt; da -&gt; m ()
updateS :: forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; Maybe (Base da) -&gt; da -&gt; m ()
updateS :: Maybe (Base da) -&gt; da -&gt; m ()
</span><a href="Data.Store.html#updateS"><span class="hs-identifier hs-var hs-var">updateS</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-513"></span><span>    </span><span class="hs-comment">-- Lock that puts loadS, writeS and updateS into sequence</span><span>
</span><span id="line-514"></span><span>    </span><span id="local-6989586621679080816"><span class="annot"><a href="#local-6989586621679080816"><span class="hs-identifier hs-var">islocked</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m (TVar m Bool)
forall a. a -&gt; m (TVar m a)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (TVar m a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-515"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679080817"><span class="hs-identifier hs-type">withLock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679080491"><span class="annot"><a href="#local-6989586621679080491"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621679080484"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080491"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080484"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080491"><span class="hs-identifier hs-type">b</span></a></span><span>
</span><span id="line-516"></span><span>        </span><span id="local-6989586621679080817"><span class="annot"><a href="#local-6989586621679080817"><span class="hs-identifier hs-var hs-var">withLock</span></a></span></span><span> </span><span id="local-6989586621679080831"><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679080831"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-517"></span><span>            </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar m Bool -&gt; STM m Bool
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679080816"><span class="hs-identifier hs-var">islocked</span></a></span><span> </span><span class="annot"><span class="annottext">STM m Bool -&gt; (Bool -&gt; STM m ()) -&gt; STM m ()
forall a b. STM m a -&gt; (a -&gt; STM m b) -&gt; STM m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-518"></span><span>                </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM m ()
forall a. STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; STM m a
</span><span class="hs-identifier hs-var">retry</span></span><span>
</span><span id="line-519"></span><span>                </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TVar m Bool -&gt; Bool -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679080816"><span class="hs-identifier hs-var">islocked</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-520"></span><span>            </span><span class="annot"><span class="annottext">m b
</span><a href="#local-6989586621679080831"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">m b -&gt; m () -&gt; m b
forall a b. m a -&gt; m b -&gt; m a
forall (m :: * -&gt; *) a b. MonadThrow m =&gt; m a -&gt; m b -&gt; m a
</span><span class="hs-operator hs-var">`finally`</span></span><span> </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar m Bool -&gt; Bool -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679080816"><span class="hs-identifier hs-var">islocked</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-521"></span><span>
</span><span id="line-522"></span><span>    </span><span class="hs-comment">-- Cache that need not be filled in the beginning</span><span>
</span><span id="line-523"></span><span>    </span><span id="local-6989586621679080832"><span class="annot"><a href="#local-6989586621679080832"><span class="hs-identifier hs-var">cache</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-type">newTVarIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Base</span></span><span> </span><span class="annot"><a href="#local-6989586621679080486"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-524"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679080833"><span class="annot"><a href="#local-6989586621679080833"><span class="hs-identifier hs-var hs-var">writeCache</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe (World qa)) -&gt; Maybe (World qa) -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe (World qa))
</span><a href="#local-6989586621679080832"><span class="hs-identifier hs-var">cache</span></a></span><span>
</span><span id="line-525"></span><span>
</span><span id="line-526"></span><span>    </span><span class="hs-comment">-- Load the value from the Store only if it is not cached and</span><span>
</span><span id="line-527"></span><span>    </span><span class="hs-comment">-- nobody else is writing to the store.</span><span>
</span><span id="line-528"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679080834"><span class="hs-identifier hs-type">load</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679080484"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Base</span></span><span> </span><span class="annot"><a href="#local-6989586621679080486"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-529"></span><span>        </span><span id="local-6989586621679080834"><span class="annot"><a href="#local-6989586621679080834"><span class="hs-identifier hs-var hs-var">load</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (m (Either SomeException (Base da)))
-&gt; m (Either SomeException (Base da))
forall (m :: * -&gt; *) a. Monad m =&gt; m (m a) -&gt; m a
</span><span class="hs-identifier hs-var">join</span></span><span> </span><span class="annot"><span class="annottext">(m (m (Either SomeException (Base da)))
 -&gt; m (Either SomeException (Base da)))
-&gt; m (m (Either SomeException (Base da)))
-&gt; m (Either SomeException (Base da))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM m (m (Either SomeException (Base da)))
-&gt; m (m (Either SomeException (Base da)))
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m (m (Either SomeException (Base da)))
 -&gt; m (m (Either SomeException (Base da))))
-&gt; STM m (m (Either SomeException (Base da)))
-&gt; m (m (Either SomeException (Base da)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-530"></span><span>            </span><span id="local-6989586621679080835"><span class="annot"><a href="#local-6989586621679080835"><span class="hs-identifier hs-var">ma</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe (World qa)) -&gt; STM m (Maybe (World qa))
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe (World qa))
</span><a href="#local-6989586621679080832"><span class="hs-identifier hs-var">cache</span></a></span><span>
</span><span id="line-531"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679080835"><span class="hs-identifier hs-type">ma</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-532"></span><span>                </span><span class="annot"><span class="annottext">Maybe (World qa)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TVar m Bool -&gt; STM m Bool
forall a. TVar m a -&gt; STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; STM m a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m Bool
</span><a href="#local-6989586621679080816"><span class="hs-identifier hs-var">islocked</span></a></span><span> </span><span class="annot"><span class="annottext">STM m Bool
-&gt; (Bool -&gt; STM m (m (Either SomeException (World qa))))
-&gt; STM m (m (Either SomeException (World qa)))
forall a b. STM m a -&gt; (a -&gt; STM m b) -&gt; STM m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-533"></span><span>                    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM m (m (Either SomeException (World qa)))
forall a. STM m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; STM m a
</span><span class="hs-identifier hs-var">retry</span></span><span>  </span><span class="hs-comment">-- somebody is writing</span><span>
</span><span id="line-534"></span><span>                    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m (Either SomeException (World qa))
-&gt; STM m (m (Either SomeException (World qa)))
forall a. a -&gt; STM m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(m (Either SomeException (World qa))
 -&gt; STM m (m (Either SomeException (World qa))))
-&gt; m (Either SomeException (World qa))
-&gt; STM m (m (Either SomeException (World qa)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">m (Either SomeException (World qa))
-&gt; m (Either SomeException (World qa))
forall b. m b -&gt; m b
</span><a href="#local-6989586621679080817"><span class="hs-identifier hs-var">withLock</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either SomeException (World qa))
 -&gt; m (Either SomeException (World qa)))
-&gt; m (Either SomeException (World qa))
-&gt; m (Either SomeException (World qa))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-535"></span><span>                        </span><span id="local-6989586621679080836"><span class="annot"><a href="#local-6989586621679080836"><span class="hs-identifier hs-var">ea</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Either SomeException (Base da))
m (Either SomeException (World qa))
</span><a href="#local-6989586621679080813"><span class="hs-identifier hs-var">loadS</span></a></span><span>
</span><span id="line-536"></span><span>                        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679080836"><span class="hs-identifier hs-type">ea</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-537"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span>  </span><span id="local-6989586621679080837"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679080837"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either SomeException (World qa)
-&gt; m (Either SomeException (World qa))
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either SomeException (World qa)
 -&gt; m (Either SomeException (World qa)))
-&gt; Either SomeException (World qa)
-&gt; m (Either SomeException (World qa))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Either SomeException (World qa)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679080837"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-538"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679080838"><span class="annot"><span class="annottext">World qa
</span><a href="#local-6989586621679080838"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-539"></span><span>                                </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (World qa) -&gt; STM m ()
</span><a href="#local-6989586621679080833"><span class="hs-identifier hs-var">writeCache</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (World qa) -&gt; STM m ()) -&gt; Maybe (World qa) -&gt; STM m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">World qa -&gt; Maybe (World qa)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">World qa
</span><a href="#local-6989586621679080838"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-540"></span><span>                                </span><span class="annot"><span class="annottext">Either SomeException (World qa)
-&gt; m (Either SomeException (World qa))
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either SomeException (World qa)
 -&gt; m (Either SomeException (World qa)))
-&gt; Either SomeException (World qa)
-&gt; m (Either SomeException (World qa))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">World qa -&gt; Either SomeException (World qa)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">World qa
</span><a href="#local-6989586621679080838"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-541"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679080839"><span class="annot"><span class="annottext">World qa
</span><a href="#local-6989586621679080839"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m (Either SomeException (World qa))
-&gt; STM m (m (Either SomeException (World qa)))
forall a. a -&gt; STM m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(m (Either SomeException (World qa))
 -&gt; STM m (m (Either SomeException (World qa))))
-&gt; m (Either SomeException (World qa))
-&gt; STM m (m (Either SomeException (World qa)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Either SomeException (World qa)
-&gt; m (Either SomeException (World qa))
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either SomeException (World qa)
 -&gt; m (Either SomeException (World qa)))
-&gt; Either SomeException (World qa)
-&gt; m (Either SomeException (World qa))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">World qa -&gt; Either SomeException (World qa)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">World qa
</span><a href="#local-6989586621679080839"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-542"></span><span>
</span><span id="line-543"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span>
</span><span id="line-544"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Data.Store.html#loadS"><span class="hs-identifier hs-var">loadS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679080834"><span class="hs-identifier hs-type">load</span></a></span><span>
</span><span id="line-545"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#queryS"><span class="hs-identifier hs-var">queryS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679080844"><span class="annot"><span class="annottext">qa b
</span><a href="#local-6989586621679080844"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">qa b -&gt; World qa -&gt; b
forall b. qa b -&gt; World qa -&gt; b
forall (qa :: * -&gt; *) b. Query qa =&gt; qa b -&gt; World qa -&gt; b
</span><a href="Data.Store.html#query"><span class="hs-identifier hs-var">query</span></a></span><span> </span><span class="annot"><span class="annottext">qa b
</span><a href="#local-6989586621679080844"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">(World qa -&gt; b) -&gt; m (World qa) -&gt; m b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Either SomeException (World qa) -&gt; m (World qa)
forall (m :: * -&gt; *) b.
MonadThrow m =&gt;
Either SomeException b -&gt; m b
</span><a href="Data.Store.html#throwLeft"><span class="hs-identifier hs-var">throwLeft</span></a></span><span> </span><span class="annot"><span class="annottext">(Either SomeException (World qa) -&gt; m (World qa))
-&gt; m (Either SomeException (World qa)) -&gt; m (World qa)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">m (Either SomeException (Base da))
m (Either SomeException (World qa))
</span><a href="#local-6989586621679080834"><span class="hs-identifier hs-var">load</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-546"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#writeS"><span class="hs-identifier hs-var">writeS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679080845"><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679080845"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall b. m b -&gt; m b
</span><a href="#local-6989586621679080817"><span class="hs-identifier hs-var">withLock</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-547"></span><span>            </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ()) -&gt; STM m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (World qa) -&gt; STM m ()
</span><a href="#local-6989586621679080833"><span class="hs-identifier hs-var">writeCache</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">World qa -&gt; Maybe (World qa)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Base da
World qa
</span><a href="#local-6989586621679080845"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-548"></span><span>            </span><span class="annot"><span class="annottext">Base da -&gt; m ()
</span><a href="#local-6989586621679080814"><span class="hs-identifier hs-var">writeS</span></a></span><span> </span><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679080845"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-549"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Store.html#updateS"><span class="hs-identifier hs-var">updateS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Data.Store.html#updateLoad"><span class="hs-identifier hs-type">updateLoad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080834"><span class="hs-identifier hs-type">load</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">throwIO</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679080846"><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679080846"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span id="local-6989586621679080847"><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679080847"><span class="hs-identifier hs-var">delta</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall b. m b -&gt; m b
</span><a href="#local-6989586621679080817"><span class="hs-identifier hs-var">withLock</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-550"></span><span>            </span><span id="local-6989586621679080848"><span class="annot"><a href="#local-6989586621679080848"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">World qa -&gt; m (World qa)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. MonadEvaluate m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">evaluate</span></span><span> </span><span class="annot"><span class="annottext">(World qa -&gt; m (World qa)) -&gt; World qa -&gt; m (World qa)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">da -&gt; Base da -&gt; Base da
forall delta. Delta delta =&gt; delta -&gt; Base delta -&gt; Base delta
</span><span class="hs-identifier hs-var">apply</span></span><span> </span><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679080847"><span class="hs-identifier hs-var">delta</span></a></span><span> </span><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679080846"><span class="hs-identifier hs-var">old</span></a></span><span>
</span><span id="line-551"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">atomically</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621679080833"><span class="hs-identifier hs-type">writeCache</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621679080848"><span class="hs-identifier hs-type">new</span></a></span><span>
</span><span id="line-552"></span><span>            </span><span class="annot"><a href="#local-6989586621679080815"><span class="hs-identifier hs-type">updateS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621679080846"><span class="hs-identifier hs-type">old</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679080847"><span class="hs-identifier hs-type">delta</span></a></span><span>
</span><span id="line-553"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-554"></span><span>
</span><span id="line-555"></span><span class="annot"><span class="hs-comment">-- | Store one type in the 'Store' of another type by using an 'Embedding'.</span></span><span>
</span><span id="line-556"></span><span id="local-6989586621679080509"><span id="local-6989586621679080511"><span id="local-6989586621679080512"><span class="annot"><a href="Data.Store.html#embedStore"><span class="hs-identifier hs-type">embedStore</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadSTM</span></span><span> </span><span class="annot"><a href="#local-6989586621679080509"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679080509"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Delta</span></span><span> </span><span class="annot"><a href="#local-6989586621679080511"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-557"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Embedding</span></span><span> </span><span class="annot"><a href="#local-6989586621679080511"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080512"><span class="hs-identifier hs-type">db</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.html#UpdateStore"><span class="hs-identifier hs-type">UpdateStore</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080509"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080512"><span class="hs-identifier hs-type">db</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080509"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Store.html#UpdateStore"><span class="hs-identifier hs-type">UpdateStore</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080509"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080511"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-558"></span><span id="embedStore"><span class="annot"><span class="annottext">embedStore :: forall (m :: * -&gt; *) da db.
(MonadSTM m, MonadMask m, Delta da) =&gt;
Embedding da db -&gt; UpdateStore m db -&gt; m (UpdateStore m da)
</span><a href="Data.Store.html#embedStore"><span class="hs-identifier hs-var hs-var">embedStore</span></a></span></span><span> </span><span id="local-6989586621679080885"><span class="annot"><span class="annottext">Embedding da db
</span><a href="#local-6989586621679080885"><span class="hs-identifier hs-var">embed</span></a></span></span><span> </span><span id="local-6989586621679080886"><span class="annot"><span class="annottext">UpdateStore m db
</span><a href="#local-6989586621679080886"><span class="hs-identifier hs-var">bstore</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-559"></span><span>    </span><span class="hs-comment">-- For reasons of efficiency, we have to store the 'Machine'</span><span>
</span><span id="line-560"></span><span>    </span><span class="hs-comment">-- that is created within the 'Embedding'.</span><span>
</span><span id="line-561"></span><span>    </span><span id="local-6989586621679080887"><span class="annot"><a href="#local-6989586621679080887"><span class="hs-identifier hs-var">machine</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (Machine da db) -&gt; m (TVar m (Maybe (Machine da db)))
forall a. a -&gt; m (TVar m a)
forall (m :: * -&gt; *) a. MonadSTM m =&gt; a -&gt; m (TVar m a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Machine da db)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-562"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679080888"><span class="annot"><a href="#local-6989586621679080888"><span class="hs-identifier hs-var hs-var">readMachine</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe (Machine da db)) -&gt; m (Maybe (Machine da db))
forall a. TVar m a -&gt; m a
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; m a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe (Machine da db))
</span><a href="#local-6989586621679080887"><span class="hs-identifier hs-var">machine</span></a></span><span>
</span><span id="line-563"></span><span>        </span><span id="local-6989586621679080889"><span class="annot"><a href="#local-6989586621679080889"><span class="hs-identifier hs-var hs-var">writeMachine</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM m () -&gt; m ()
forall a. HasCallStack =&gt; STM m a -&gt; m a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM m () -&gt; m ())
-&gt; (Machine da db -&gt; STM m ()) -&gt; Machine da db -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe (Machine da db)) -&gt; Maybe (Machine da db) -&gt; STM m ()
forall a. TVar m a -&gt; a -&gt; STM m ()
forall (m :: * -&gt; *) a. MonadSTM m =&gt; TVar m a -&gt; a -&gt; STM m ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar m (Maybe (Machine da db))
</span><a href="#local-6989586621679080887"><span class="hs-identifier hs-var">machine</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Machine da db) -&gt; STM m ())
-&gt; (Machine da db -&gt; Maybe (Machine da db))
-&gt; Machine da db
-&gt; STM m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Machine da db -&gt; Maybe (Machine da db)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span>
</span><span id="line-564"></span><span>
</span><span id="line-565"></span><span>    </span><span class="hs-comment">-- Operations of the result 'Store'.</span><span>
</span><span id="line-566"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679080890"><span class="annot"><a href="#local-6989586621679080890"><span class="hs-identifier hs-var hs-var">load</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UpdateStore m db -&gt; m (Either SomeException (Base db))
forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; m (Either SomeException (Base da))
</span><a href="Data.Store.html#loadS"><span class="hs-identifier hs-var">loadS</span></a></span><span> </span><span class="annot"><span class="annottext">UpdateStore m db
</span><a href="#local-6989586621679080886"><span class="hs-identifier hs-var">bstore</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either SomeException (Base db))
-&gt; (Either SomeException (Base db)
    -&gt; m (Either SomeException (Base da)))
-&gt; m (Either SomeException (Base da))
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-567"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span>  </span><span id="local-6989586621679080891"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679080891"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either SomeException (Base da)
-&gt; m (Either SomeException (Base da))
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either SomeException (Base da)
 -&gt; m (Either SomeException (Base da)))
-&gt; Either SomeException (Base da)
-&gt; m (Either SomeException (Base da))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Either SomeException (Base da)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679080891"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-568"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679080892"><span class="annot"><span class="annottext">Base db
</span><a href="#local-6989586621679080892"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Embedding da db
-&gt; Base db -&gt; Either SomeException (Base da, Machine da db)
forall da db.
Embedding da db
-&gt; Base db -&gt; Either SomeException (Base da, Machine da db)
</span><span class="hs-identifier hs-var">project</span></span><span> </span><span class="annot"><span class="annottext">Embedding da db
</span><a href="#local-6989586621679080885"><span class="hs-identifier hs-var">embed</span></a></span><span> </span><span class="annot"><span class="annottext">Base db
</span><a href="#local-6989586621679080892"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-569"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span>  </span><span id="local-6989586621679080893"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679080893"><span class="hs-identifier hs-var">e</span></a></span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either SomeException (Base da)
-&gt; m (Either SomeException (Base da))
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either SomeException (Base da)
 -&gt; m (Either SomeException (Base da)))
-&gt; Either SomeException (Base da)
-&gt; m (Either SomeException (Base da))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Either SomeException (Base da)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679080893"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-570"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679080894"><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679080894"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679080895"><span class="annot"><span class="annottext">Machine da db
</span><a href="#local-6989586621679080895"><span class="hs-identifier hs-var">mab</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-571"></span><span>                    </span><span class="annot"><span class="annottext">Machine da db -&gt; m ()
</span><a href="#local-6989586621679080889"><span class="hs-identifier hs-var">writeMachine</span></a></span><span> </span><span class="annot"><span class="annottext">Machine da db
</span><a href="#local-6989586621679080895"><span class="hs-identifier hs-var">mab</span></a></span><span>
</span><span id="line-572"></span><span>                    </span><span class="annot"><span class="annottext">Either SomeException (Base da)
-&gt; m (Either SomeException (Base da))
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either SomeException (Base da)
 -&gt; m (Either SomeException (Base da)))
-&gt; Either SomeException (Base da)
-&gt; m (Either SomeException (Base da))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Base da -&gt; Either SomeException (Base da)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679080894"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-573"></span><span>        </span><span id="local-6989586621679080896"><span class="annot"><a href="#local-6989586621679080896"><span class="hs-identifier hs-var hs-var">write</span></a></span></span><span> </span><span id="local-6989586621679080897"><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679080897"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-574"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679080898"><span class="annot"><span class="annottext">mab :: Machine da db
</span><a href="#local-6989586621679080898"><span class="hs-identifier hs-var hs-var">mab</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Embedding da db -&gt; Base da -&gt; Machine da db
forall da db. Embedding da db -&gt; Base da -&gt; Machine da db
</span><span class="hs-identifier hs-var">inject</span></span><span> </span><span class="annot"><span class="annottext">Embedding da db
</span><a href="#local-6989586621679080885"><span class="hs-identifier hs-var">embed</span></a></span><span> </span><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679080897"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-575"></span><span>            </span><span class="annot"><span class="annottext">((forall a. m a -&gt; m a) -&gt; m ()) -&gt; m ()
forall b. ((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) b.
MonadMask m =&gt;
((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">mask</span></span><span> </span><span class="annot"><span class="annottext">(((forall a. m a -&gt; m a) -&gt; m ()) -&gt; m ())
-&gt; ((forall a. m a -&gt; m a) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679080899"><span class="annot"><span class="annottext">forall a. m a -&gt; m a
</span><a href="#local-6989586621679080899"><span class="hs-identifier hs-var">restore</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-576"></span><span>                </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall a. m a -&gt; m a
</span><a href="#local-6989586621679080899"><span class="hs-identifier hs-var">restore</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UpdateStore m db -&gt; Base db -&gt; m ()
forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; Base da -&gt; m ()
</span><a href="Data.Store.html#writeS"><span class="hs-identifier hs-var">writeS</span></a></span><span> </span><span class="annot"><span class="annottext">UpdateStore m db
</span><a href="#local-6989586621679080886"><span class="hs-identifier hs-var">bstore</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Machine da db -&gt; Base db
forall da db. Machine da db -&gt; Base db
</span><span class="hs-identifier hs-var">state_</span></span><span> </span><span class="annot"><span class="annottext">Machine da db
</span><a href="#local-6989586621679080898"><span class="hs-identifier hs-var">mab</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-577"></span><span>                </span><span class="annot"><span class="annottext">Machine da db -&gt; m ()
</span><a href="#local-6989586621679080889"><span class="hs-identifier hs-var">writeMachine</span></a></span><span> </span><span class="annot"><span class="annottext">Machine da db
</span><a href="#local-6989586621679080898"><span class="hs-identifier hs-var">mab</span></a></span><span>
</span><span id="line-578"></span><span>        </span><span id="local-6989586621679080901"><span class="annot"><a href="#local-6989586621679080901"><span class="hs-identifier hs-var hs-var">update</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (Either SomeException (Base da))
-&gt; (SomeException -&gt; m ())
-&gt; (Base da -&gt; da -&gt; m ())
-&gt; Maybe (Base da)
-&gt; da
-&gt; m ()
forall e (m :: * -&gt; *) t b da.
(Exception e, Monad m) =&gt;
m (Either e t)
-&gt; (e -&gt; m b) -&gt; (t -&gt; da -&gt; m b) -&gt; Maybe t -&gt; da -&gt; m b
</span><a href="Data.Store.html#updateLoad"><span class="hs-identifier hs-var">updateLoad</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either SomeException (Base da))
</span><a href="#local-6989586621679080890"><span class="hs-identifier hs-var">load</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; m ()
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">((Base da -&gt; da -&gt; m ()) -&gt; Maybe (Base da) -&gt; da -&gt; m ())
-&gt; (Base da -&gt; da -&gt; m ()) -&gt; Maybe (Base da) -&gt; da -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679080902"><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679080902"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679080903"><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679080903"><span class="hs-identifier hs-var">da</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-579"></span><span>            </span><span class="annot"><span class="annottext">m (Maybe (Machine da db))
</span><a href="#local-6989586621679080888"><span class="hs-identifier hs-var">readMachine</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe (Machine da db))
-&gt; (Maybe (Machine da db) -&gt; m ()) -&gt; m ()
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-580"></span><span>                </span><span class="annot"><span class="annottext">Maybe (Machine da db)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- we were missing the initial write</span><span>
</span><span id="line-581"></span><span>                    </span><span class="annot"><span class="annottext">Base da -&gt; m ()
</span><a href="#local-6989586621679080896"><span class="hs-identifier hs-var">write</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">da -&gt; Base da -&gt; Base da
forall delta. Delta delta =&gt; delta -&gt; Base delta -&gt; Base delta
</span><span class="hs-identifier hs-var">apply</span></span><span> </span><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679080903"><span class="hs-identifier hs-var">da</span></a></span><span> </span><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679080902"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-582"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679080904"><span class="annot"><span class="annottext">Machine da db
</span><a href="#local-6989586621679080904"><span class="hs-identifier hs-var">mab1</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- advance the machine by one step</span><span>
</span><span id="line-583"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679080905"><span class="annot"><span class="annottext">db
</span><a href="#local-6989586621679080905"><span class="hs-identifier hs-var">db</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679080906"><span class="annot"><span class="annottext">Machine da db
</span><a href="#local-6989586621679080906"><span class="hs-identifier hs-var">mab2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Machine da db -&gt; (Base da, da) -&gt; (db, Machine da db)
forall da db. Machine da db -&gt; (Base da, da) -&gt; (db, Machine da db)
</span><span class="hs-identifier hs-var">step_</span></span><span> </span><span class="annot"><span class="annottext">Machine da db
</span><a href="#local-6989586621679080904"><span class="hs-identifier hs-var">mab1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679080902"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679080903"><span class="hs-identifier hs-var">da</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-584"></span><span>                    </span><span class="annot"><span class="annottext">((forall a. m a -&gt; m a) -&gt; m ()) -&gt; m ()
forall b. ((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) b.
MonadMask m =&gt;
((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">mask</span></span><span> </span><span class="annot"><span class="annottext">(((forall a. m a -&gt; m a) -&gt; m ()) -&gt; m ())
-&gt; ((forall a. m a -&gt; m a) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679080908"><span class="annot"><span class="annottext">forall a. m a -&gt; m a
</span><a href="#local-6989586621679080908"><span class="hs-identifier hs-var">restore</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-585"></span><span>                        </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall a. m a -&gt; m a
</span><a href="#local-6989586621679080908"><span class="hs-identifier hs-var">restore</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UpdateStore m db -&gt; Maybe (Base db) -&gt; db -&gt; m ()
forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; Maybe (Base da) -&gt; da -&gt; m ()
</span><a href="Data.Store.html#updateS"><span class="hs-identifier hs-var">updateS</span></a></span><span> </span><span class="annot"><span class="annottext">UpdateStore m db
</span><a href="#local-6989586621679080886"><span class="hs-identifier hs-var">bstore</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Base db -&gt; Maybe (Base db)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Base db -&gt; Maybe (Base db)) -&gt; Base db -&gt; Maybe (Base db)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Machine da db -&gt; Base db
forall da db. Machine da db -&gt; Base db
</span><span class="hs-identifier hs-var">state_</span></span><span> </span><span class="annot"><span class="annottext">Machine da db
</span><a href="#local-6989586621679080906"><span class="hs-identifier hs-var">mab2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">db
</span><a href="#local-6989586621679080905"><span class="hs-identifier hs-var">db</span></a></span><span>
</span><span id="line-586"></span><span>                        </span><span class="annot"><span class="annottext">Machine da db -&gt; m ()
</span><a href="#local-6989586621679080889"><span class="hs-identifier hs-var">writeMachine</span></a></span><span> </span><span class="annot"><span class="annottext">Machine da db
</span><a href="#local-6989586621679080906"><span class="hs-identifier hs-var">mab2</span></a></span><span>
</span><span id="line-587"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">pure</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Data.Store.html#mkUpdateStore"><span class="hs-identifier hs-type">mkUpdateStore</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080890"><span class="hs-identifier hs-type">load</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080896"><span class="hs-identifier hs-type">write</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080901"><span class="hs-identifier hs-type">update</span></a></span><span>
</span><span id="line-588"></span><span>
</span><span id="line-589"></span><span class="hs-comment">-- | Store one type in the 'Store' of another type by using an 'Embedding'.</span><span>
</span><span id="line-590"></span><span class="hs-comment">--</span><span>
</span><span id="line-591"></span><span class="hs-comment">-- Note: This function is exported for testing and documentation only,</span><span>
</span><span id="line-592"></span><span class="hs-comment">-- use the more efficient 'embedStore' instead.</span><span>
</span><span id="line-593"></span><span id="local-6989586621679080532"><span id="local-6989586621679080533"><span id="local-6989586621679080534"><span class="annot"><a href="Data.Store.html#embedStore%27"><span class="hs-identifier hs-type">embedStore'</span></a></span><span>
</span><span id="line-594"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679080532"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621679080532"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-595"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Embedding'</span></span><span> </span><span class="annot"><a href="#local-6989586621679080533"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080534"><span class="hs-identifier hs-type">db</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.html#UpdateStore"><span class="hs-identifier hs-type">UpdateStore</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080532"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080534"><span class="hs-identifier hs-type">db</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.html#UpdateStore"><span class="hs-identifier hs-type">UpdateStore</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080532"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080533"><span class="hs-identifier hs-type">da</span></a></span></span></span></span><span>
</span><span id="line-596"></span><span id="embedStore%27"><span class="annot"><span class="annottext">embedStore' :: forall (m :: * -&gt; *) da db.
(Monad m, MonadThrow m) =&gt;
Embedding' da db -&gt; UpdateStore m db -&gt; UpdateStore m da
</span><a href="Data.Store.html#embedStore%27"><span class="hs-identifier hs-var hs-var">embedStore'</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Embedding'</span></span><span class="hs-special">{</span><span id="local-6989586621679080935"><span class="annot"><span class="annottext">b -&gt; Either SomeException a
load :: b -&gt; Either SomeException a
load :: ()
</span><a href="#local-6989586621679080935"><span class="hs-identifier hs-var hs-var">load</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679080937"><span class="annot"><span class="annottext">a -&gt; b
write :: a -&gt; b
write :: ()
</span><a href="#local-6989586621679080937"><span class="hs-identifier hs-var hs-var">write</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679080939"><span class="annot"><span class="annottext">a -&gt; b -&gt; da -&gt; db
update :: a -&gt; b -&gt; da -&gt; db
update :: ()
</span><a href="#local-6989586621679080939"><span class="hs-identifier hs-var hs-var">update</span></a></span></span><span class="hs-special">}</span><span> </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span class="hs-special">{</span><span id="local-6989586621679080941"><span class="annot"><span class="annottext">m (Either SomeException (Base db))
loadS :: forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; m (Either SomeException (Base da))
loadS :: m (Either SomeException (Base db))
</span><a href="Data.Store.html#loadS"><span class="hs-identifier hs-var hs-var">loadS</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679080942"><span class="annot"><span class="annottext">Base db -&gt; m ()
writeS :: forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; Base da -&gt; m ()
writeS :: Base db -&gt; m ()
</span><a href="Data.Store.html#writeS"><span class="hs-identifier hs-var hs-var">writeS</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679080943"><span class="annot"><span class="annottext">Maybe (Base db) -&gt; db -&gt; m ()
updateS :: forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; Maybe (Base da) -&gt; da -&gt; m ()
updateS :: Maybe (Base db) -&gt; db -&gt; m ()
</span><a href="Data.Store.html#updateS"><span class="hs-identifier hs-var hs-var">updateS</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-597"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-598"></span><span>        </span><span id="local-6989586621679080944"><span class="annot"><span class="annottext">loadL :: m (Either SomeException a)
</span><a href="#local-6989586621679080944"><span class="hs-identifier hs-var hs-var">loadL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; Either SomeException a
</span><a href="#local-6989586621679080935"><span class="hs-identifier hs-var">load</span></a></span><span> </span><span class="annot"><span class="annottext">(b -&gt; Either SomeException a)
-&gt; Either SomeException b -&gt; Either SomeException a
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Either SomeException b -&gt; Either SomeException a)
-&gt; m (Either SomeException b) -&gt; m (Either SomeException a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">m (Either SomeException b)
m (Either SomeException (Base db))
</span><a href="#local-6989586621679080941"><span class="hs-identifier hs-var">loadS</span></a></span><span>
</span><span id="line-599"></span><span>        </span><span id="local-6989586621679080945"><span class="annot"><span class="annottext">updateL :: Maybe a -&gt; da -&gt; m ()
</span><a href="#local-6989586621679080945"><span class="hs-identifier hs-var hs-var">updateL</span></a></span></span><span> </span><span id="local-6989586621679080946"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679080946"><span class="hs-identifier hs-var">ma</span></a></span></span><span> </span><span id="local-6989586621679080947"><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679080947"><span class="hs-identifier hs-var">da</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679080946"><span class="hs-identifier hs-var">ma</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-600"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679080948"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679080948"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m (Either SomeException b)
m (Either SomeException (Base db))
</span><a href="#local-6989586621679080941"><span class="hs-identifier hs-var">loadS</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either SomeException b)
-&gt; (Either SomeException b -&gt; m ()) -&gt; m ()
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-601"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span>  </span><span class="annot"><span class="annottext">SomeException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-602"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679080949"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679080949"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Base db) -&gt; db -&gt; m ()
</span><a href="#local-6989586621679080943"><span class="hs-identifier hs-var">updateS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; Maybe b
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679080949"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; b -&gt; da -&gt; db
</span><a href="#local-6989586621679080939"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679080948"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679080949"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679080947"><span class="hs-identifier hs-var">da</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-603"></span><span>            </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-604"></span><span>                </span><span id="local-6989586621679080950"><span class="annot"><a href="#local-6989586621679080950"><span class="hs-identifier hs-var">ea</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Either SomeException a)
</span><a href="#local-6989586621679080944"><span class="hs-identifier hs-var">loadL</span></a></span><span>
</span><span id="line-605"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679080950"><span class="hs-identifier hs-type">ea</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-606"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span>  </span><span id="local-6989586621679080951"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679080951"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; m ()
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679080951"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-607"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679080952"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679080952"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; da -&gt; m ()
</span><a href="#local-6989586621679080945"><span class="hs-identifier hs-var">updateL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679080952"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679080947"><span class="hs-identifier hs-var">da</span></a></span><span>
</span><span id="line-608"></span><span>    </span><span class="hs-keyword">in</span><span>  </span><span class="annot"><span class="annottext">m (Either SomeException a)
-&gt; (a -&gt; m ())
-&gt; (Maybe a -&gt; da -&gt; m ())
-&gt; Store m (Whole (Base da)) da
forall (m :: * -&gt; *) a da.
(Monad m, MonadThrow m, a ~ Base da, Delta da) =&gt;
m (Either SomeException a)
-&gt; (a -&gt; m ()) -&gt; (Maybe a -&gt; da -&gt; m ()) -&gt; UpdateStore m da
</span><a href="Data.Store.html#mkUpdateStore"><span class="hs-identifier hs-var">mkUpdateStore</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either SomeException a)
</span><a href="#local-6989586621679080944"><span class="hs-identifier hs-var">loadL</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; m ()
Base db -&gt; m ()
</span><a href="#local-6989586621679080942"><span class="hs-identifier hs-var">writeS</span></a></span><span> </span><span class="annot"><span class="annottext">(b -&gt; m ()) -&gt; (a -&gt; b) -&gt; a -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621679080937"><span class="hs-identifier hs-var">write</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; da -&gt; m ()
</span><a href="#local-6989586621679080945"><span class="hs-identifier hs-var">updateL</span></a></span><span>
</span><span id="line-609"></span><span>
</span><span id="line-610"></span><span class="annot"><span class="hs-comment">-- | Lift</span></span><span>
</span><span id="line-611"></span><span id="local-6989586621679080542"><span id="local-6989586621679080544"><span id="local-6989586621679080545"><span id="local-6989586621679080546"><span class="annot"><a href="Data.Store.html#hoistStore"><span class="hs-identifier hs-type">hoistStore</span></a></span><span>
</span><span id="line-612"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679080542"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-613"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679080543"><span class="annot"><a href="#local-6989586621679080543"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="#local-6989586621679080542"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080543"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080544"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080543"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-614"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080542"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080545"><span class="hs-identifier hs-type">qa</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080546"><span class="hs-identifier hs-type">da</span></a></span><span>
</span><span id="line-615"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080544"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080545"><span class="hs-identifier hs-type">qa</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080546"><span class="hs-identifier hs-type">da</span></a></span></span></span></span></span><span>
</span><span id="line-616"></span><span id="hoistStore"><span class="annot"><span class="annottext">hoistStore :: forall (m :: * -&gt; *) (n :: * -&gt; *) (qa :: * -&gt; *) da.
Monad m =&gt;
(forall a. m a -&gt; n a) -&gt; Store m qa da -&gt; Store n qa da
</span><a href="Data.Store.html#hoistStore"><span class="hs-identifier hs-var hs-var">hoistStore</span></a></span></span><span> </span><span id="local-6989586621679080954"><span class="annot"><span class="annottext">forall a. m a -&gt; n a
</span><a href="#local-6989586621679080954"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span class="hs-special">{</span><span id="local-6989586621679080955"><span class="annot"><span class="annottext">m (Either SomeException (Base da))
loadS :: forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; m (Either SomeException (Base da))
loadS :: m (Either SomeException (Base da))
</span><a href="Data.Store.html#loadS"><span class="hs-identifier hs-var hs-var">loadS</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679080956"><span class="annot"><span class="annottext">Base da -&gt; m ()
writeS :: forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; Base da -&gt; m ()
writeS :: Base da -&gt; m ()
</span><a href="Data.Store.html#writeS"><span class="hs-identifier hs-var hs-var">writeS</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679080957"><span class="annot"><span class="annottext">Maybe (Base da) -&gt; da -&gt; m ()
updateS :: forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; Maybe (Base da) -&gt; da -&gt; m ()
updateS :: Maybe (Base da) -&gt; da -&gt; m ()
</span><a href="Data.Store.html#updateS"><span class="hs-identifier hs-var hs-var">updateS</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679080958"><span class="annot"><span class="annottext">forall b. qa b -&gt; m b
queryS :: forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; forall b. qa b -&gt; m b
queryS :: forall b. qa b -&gt; m b
</span><a href="Data.Store.html#queryS"><span class="hs-identifier hs-var hs-var">queryS</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span>
</span><span id="line-617"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">loadS :: n (Either SomeException (Base da))
</span><a href="Data.Store.html#loadS"><span class="hs-identifier hs-var">loadS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (Either SomeException (Base da))
-&gt; n (Either SomeException (Base da))
forall a. m a -&gt; n a
</span><a href="#local-6989586621679080954"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either SomeException (Base da))
</span><a href="#local-6989586621679080955"><span class="hs-identifier hs-var">loadS</span></a></span><span>
</span><span id="line-618"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">writeS :: Base da -&gt; n ()
</span><a href="Data.Store.html#writeS"><span class="hs-identifier hs-var">writeS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m () -&gt; n ()
forall a. m a -&gt; n a
</span><a href="#local-6989586621679080954"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; n ()) -&gt; (Base da -&gt; m ()) -&gt; Base da -&gt; n ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Base da -&gt; m ()
</span><a href="#local-6989586621679080956"><span class="hs-identifier hs-var">writeS</span></a></span><span>
</span><span id="line-619"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">updateS :: Maybe (Base da) -&gt; da -&gt; n ()
</span><a href="Data.Store.html#updateS"><span class="hs-identifier hs-var">updateS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679080959"><span class="annot"><span class="annottext">Maybe (Base da)
</span><a href="#local-6989586621679080959"><span class="hs-identifier hs-var">ma</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m () -&gt; n ()
forall a. m a -&gt; n a
</span><a href="#local-6989586621679080954"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; n ()) -&gt; (da -&gt; m ()) -&gt; da -&gt; n ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Base da) -&gt; da -&gt; m ()
</span><a href="#local-6989586621679080957"><span class="hs-identifier hs-var">updateS</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Base da)
</span><a href="#local-6989586621679080959"><span class="hs-identifier hs-var">ma</span></a></span><span>
</span><span id="line-620"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">queryS :: forall b. qa b -&gt; n b
</span><a href="Data.Store.html#queryS"><span class="hs-identifier hs-var">queryS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m b -&gt; n b
forall a. m a -&gt; n a
</span><a href="#local-6989586621679080954"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(m b -&gt; n b) -&gt; (qa b -&gt; m b) -&gt; qa b -&gt; n b
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">qa b -&gt; m b
forall b. qa b -&gt; m b
</span><a href="#local-6989586621679080958"><span class="hs-identifier hs-var">queryS</span></a></span><span>
</span><span id="line-621"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-622"></span><span>
</span><span id="line-623"></span><span class="hs-comment">-- | Combine two 'Stores' into a 'Store' for pairs.</span><span>
</span><span id="line-624"></span><span class="hs-comment">--</span><span>
</span><span id="line-625"></span><span class="hs-comment">-- TODO: Handle the case where 'writeS' or 'updateS' throw an exception</span><span>
</span><span id="line-626"></span><span class="hs-comment">-- and partially break the 'Store'.</span><span>
</span><span id="line-627"></span><span id="local-6989586621679080552"><span id="local-6989586621679080553"><span id="local-6989586621679080554"><span id="local-6989586621679080555"><span id="local-6989586621679080556"><span class="annot"><a href="Data.Store.html#pairStores"><span class="hs-identifier hs-type">pairStores</span></a></span><span>
</span><span id="line-628"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679080552"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-629"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080552"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080553"><span class="hs-identifier hs-type">qa</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080554"><span class="hs-identifier hs-type">da</span></a></span><span>
</span><span id="line-630"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080552"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080555"><span class="hs-identifier hs-type">qb</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080556"><span class="hs-identifier hs-type">db</span></a></span><span>
</span><span id="line-631"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080552"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679080553"><span class="hs-identifier hs-type">qa</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">:+:</span></span><span> </span><span class="annot"><a href="#local-6989586621679080555"><span class="hs-identifier hs-type">qb</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679080554"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">,</span><span class="annot"><a href="#local-6989586621679080556"><span class="hs-identifier hs-type">db</span></a></span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-632"></span><span id="pairStores"><span class="annot"><span class="annottext">pairStores :: forall (m :: * -&gt; *) (qa :: * -&gt; *) da (qb :: * -&gt; *) db.
Monad m =&gt;
Store m qa da -&gt; Store m qb db -&gt; Store m (qa :+: qb) (da, db)
</span><a href="Data.Store.html#pairStores"><span class="hs-identifier hs-var hs-var">pairStores</span></a></span></span><span> </span><span id="local-6989586621679080970"><span class="annot"><span class="annottext">Store m qa da
</span><a href="#local-6989586621679080970"><span class="hs-identifier hs-var">sa</span></a></span></span><span> </span><span id="local-6989586621679080971"><span class="annot"><span class="annottext">Store m qb db
</span><a href="#local-6989586621679080971"><span class="hs-identifier hs-var">sb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span>
</span><span id="line-633"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">loadS :: m (Either SomeException (Base (da, db)))
</span><a href="Data.Store.html#loadS"><span class="hs-identifier hs-var">loadS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Base da -&gt; Base db -&gt; (Base da, Base db))
-&gt; Either SomeException (Base da)
-&gt; Either SomeException (Base db)
-&gt; Either SomeException (Base da, Base db)
forall a b c.
(a -&gt; b -&gt; c)
-&gt; Either SomeException a
-&gt; Either SomeException b
-&gt; Either SomeException c
forall (f :: * -&gt; *) a b c.
Applicative f =&gt;
(a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c
</span><span class="hs-identifier hs-var">liftA2</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Either SomeException (Base da)
 -&gt; Either SomeException (Base db)
 -&gt; Either SomeException (Base da, Base db))
-&gt; m (Either SomeException (Base da))
-&gt; m (Either SomeException (Base db)
      -&gt; Either SomeException (Base da, Base db))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Store m qa da -&gt; m (Either SomeException (Base da))
forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; m (Either SomeException (Base da))
</span><a href="Data.Store.html#loadS"><span class="hs-identifier hs-var">loadS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m qa da
</span><a href="#local-6989586621679080970"><span class="hs-identifier hs-var">sa</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either SomeException (Base db)
   -&gt; Either SomeException (Base da, Base db))
-&gt; m (Either SomeException (Base db))
-&gt; m (Either SomeException (Base da, Base db))
forall a b. m (a -&gt; b) -&gt; m a -&gt; m b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Store m qb db -&gt; m (Either SomeException (Base db))
forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; m (Either SomeException (Base da))
</span><a href="Data.Store.html#loadS"><span class="hs-identifier hs-var">loadS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m qb db
</span><a href="#local-6989586621679080971"><span class="hs-identifier hs-var">sb</span></a></span><span>
</span><span id="line-634"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">queryS :: forall b. (:+:) qa qb b -&gt; m b
</span><a href="Data.Store.html#queryS"><span class="hs-identifier hs-var">queryS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-635"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">L1</span></span><span> </span><span id="local-6989586621679080973"><span class="annot"><span class="annottext">qa b
</span><a href="#local-6989586621679080973"><span class="hs-identifier hs-var">qa</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Store m qa da -&gt; forall b. qa b -&gt; m b
forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; forall b. qa b -&gt; m b
</span><a href="Data.Store.html#queryS"><span class="hs-identifier hs-var">queryS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m qa da
</span><a href="#local-6989586621679080970"><span class="hs-identifier hs-var">sa</span></a></span><span> </span><span class="annot"><span class="annottext">qa b
</span><a href="#local-6989586621679080973"><span class="hs-identifier hs-var">qa</span></a></span><span>
</span><span id="line-636"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">R1</span></span><span> </span><span id="local-6989586621679080975"><span class="annot"><span class="annottext">qb b
</span><a href="#local-6989586621679080975"><span class="hs-identifier hs-var">qb</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Store m qb db -&gt; forall b. qb b -&gt; m b
forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; forall b. qa b -&gt; m b
</span><a href="Data.Store.html#queryS"><span class="hs-identifier hs-var">queryS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m qb db
</span><a href="#local-6989586621679080971"><span class="hs-identifier hs-var">sb</span></a></span><span> </span><span class="annot"><span class="annottext">qb b
</span><a href="#local-6989586621679080975"><span class="hs-identifier hs-var">qb</span></a></span><span>
</span><span id="line-637"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">writeS :: Base (da, db) -&gt; m ()
</span><a href="Data.Store.html#writeS"><span class="hs-identifier hs-var">writeS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679080976"><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679080976"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679080977"><span class="annot"><span class="annottext">Base db
</span><a href="#local-6989586621679080977"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Store m qa da -&gt; Base da -&gt; m ()
forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; Base da -&gt; m ()
</span><a href="Data.Store.html#writeS"><span class="hs-identifier hs-var">writeS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m qa da
</span><a href="#local-6989586621679080970"><span class="hs-identifier hs-var">sa</span></a></span><span> </span><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679080976"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m () -&gt; m ()
forall a b. m a -&gt; m b -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Store m qb db -&gt; Base db -&gt; m ()
forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; Base da -&gt; m ()
</span><a href="Data.Store.html#writeS"><span class="hs-identifier hs-var">writeS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m qb db
</span><a href="#local-6989586621679080971"><span class="hs-identifier hs-var">sb</span></a></span><span> </span><span class="annot"><span class="annottext">Base db
</span><a href="#local-6989586621679080977"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-638"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">updateS :: Maybe (Base (da, db)) -&gt; (da, db) -&gt; m ()
</span><a href="Data.Store.html#updateS"><span class="hs-identifier hs-var">updateS</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679080978"><span class="annot"><span class="annottext">Maybe (Base (da, db))
</span><a href="#local-6989586621679080978"><span class="hs-identifier hs-var">mi</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679080979"><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679080979"><span class="hs-identifier hs-var">da</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679080980"><span class="annot"><span class="annottext">db
</span><a href="#local-6989586621679080980"><span class="hs-identifier hs-var">db</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-639"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Base (da, db))
</span><a href="#local-6989586621679080978"><span class="hs-identifier hs-var">mi</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-640"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Base (da, db))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Store m qa da -&gt; Maybe (Base da) -&gt; da -&gt; m ()
forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; Maybe (Base da) -&gt; da -&gt; m ()
</span><a href="Data.Store.html#updateS"><span class="hs-identifier hs-var">updateS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m qa da
</span><a href="#local-6989586621679080970"><span class="hs-identifier hs-var">sa</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Base da)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679080979"><span class="hs-identifier hs-var">da</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m () -&gt; m ()
forall a b. m a -&gt; m b -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Store m qb db -&gt; Maybe (Base db) -&gt; db -&gt; m ()
forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; Maybe (Base da) -&gt; da -&gt; m ()
</span><a href="Data.Store.html#updateS"><span class="hs-identifier hs-var">updateS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m qb db
</span><a href="#local-6989586621679080971"><span class="hs-identifier hs-var">sb</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Base db)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">db
</span><a href="#local-6989586621679080980"><span class="hs-identifier hs-var">db</span></a></span><span>
</span><span id="line-641"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679080981"><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679080981"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679080982"><span class="annot"><span class="annottext">Base db
</span><a href="#local-6989586621679080982"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Store m qa da -&gt; Maybe (Base da) -&gt; da -&gt; m ()
forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; Maybe (Base da) -&gt; da -&gt; m ()
</span><a href="Data.Store.html#updateS"><span class="hs-identifier hs-var">updateS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m qa da
</span><a href="#local-6989586621679080970"><span class="hs-identifier hs-var">sa</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Base da -&gt; Maybe (Base da)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679080981"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679080979"><span class="hs-identifier hs-var">da</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m () -&gt; m ()
forall a b. m a -&gt; m b -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Store m qb db -&gt; Maybe (Base db) -&gt; db -&gt; m ()
forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; Maybe (Base da) -&gt; da -&gt; m ()
</span><a href="Data.Store.html#updateS"><span class="hs-identifier hs-var">updateS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m qb db
</span><a href="#local-6989586621679080971"><span class="hs-identifier hs-var">sb</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Base db -&gt; Maybe (Base db)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Base db
</span><a href="#local-6989586621679080982"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">db
</span><a href="#local-6989586621679080980"><span class="hs-identifier hs-var">db</span></a></span><span>
</span><span id="line-642"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-643"></span><span>
</span><span id="line-644"></span><span class="hs-comment">{-------------------------------------------------------------------------------
    Helpers
-------------------------------------------------------------------------------}</span><span>
</span><span id="line-647"></span><span class="hs-comment">-- | Helper for implementing `updateS`</span><span>
</span><span id="line-648"></span><span class="hs-comment">-- for the case where a value is not yet loaded.</span><span>
</span><span id="line-649"></span><span id="local-6989586621679080500"><span id="local-6989586621679080501"><span id="local-6989586621679080502"><span id="local-6989586621679080503"><span id="local-6989586621679080504"><span class="annot"><a href="Data.Store.html#updateLoad"><span class="hs-identifier hs-type">updateLoad</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="#local-6989586621679080500"><span class="hs-identifier hs-type">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679080501"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-650"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080501"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="#local-6989586621679080500"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080502"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-comment">-- ^ How to load the value.</span></span><span>
</span><span id="line-651"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679080500"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080501"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080503"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-comment">-- ^ What to do with the error when loading the value.</span></span><span>
</span><span id="line-652"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679080502"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080504"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080501"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080503"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-comment">-- ^ What to do with the value.</span></span><span>
</span><span id="line-653"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679080502"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Value, maybe loaded, maybe not.</span></span><span>
</span><span id="line-654"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080504"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Delta.</span></span><span>
</span><span id="line-655"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080501"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080503"><span class="hs-identifier hs-type">b</span></a></span></span></span></span></span></span><span>
</span><span id="line-656"></span><span id="updateLoad"><span class="annot"><span class="annottext">updateLoad :: forall e (m :: * -&gt; *) t b da.
(Exception e, Monad m) =&gt;
m (Either e t)
-&gt; (e -&gt; m b) -&gt; (t -&gt; da -&gt; m b) -&gt; Maybe t -&gt; da -&gt; m b
</span><a href="Data.Store.html#updateLoad"><span class="hs-identifier hs-var hs-var">updateLoad</span></a></span></span><span> </span><span id="local-6989586621679080986"><span class="annot"><span class="annottext">m (Either e t)
</span><a href="#local-6989586621679080986"><span class="hs-identifier hs-var">load</span></a></span></span><span> </span><span id="local-6989586621679080987"><span class="annot"><span class="annottext">e -&gt; m b
</span><a href="#local-6989586621679080987"><span class="hs-identifier hs-var">handle</span></a></span></span><span> </span><span id="local-6989586621679080988"><span class="annot"><span class="annottext">t -&gt; da -&gt; m b
</span><a href="#local-6989586621679080988"><span class="hs-identifier hs-var">update'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe t
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span id="local-6989586621679080989"><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679080989"><span class="hs-identifier hs-var">da</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-657"></span><span>    </span><span id="local-6989586621679080990"><span class="annot"><a href="#local-6989586621679080990"><span class="hs-identifier hs-var">ea</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Either e t)
</span><a href="#local-6989586621679080986"><span class="hs-identifier hs-var">load</span></a></span><span>
</span><span id="line-658"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><a href="#local-6989586621679080990"><span class="hs-identifier hs-type">ea</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-659"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679080991"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679080991"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">e -&gt; m b
</span><a href="#local-6989586621679080987"><span class="hs-identifier hs-var">handle</span></a></span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679080991"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-660"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679080992"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679080992"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">t -&gt; da -&gt; m b
</span><a href="#local-6989586621679080988"><span class="hs-identifier hs-var">update'</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679080992"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679080989"><span class="hs-identifier hs-var">da</span></a></span><span>
</span><span id="line-661"></span><span class="annot"><a href="Data.Store.html#updateLoad"><span class="hs-identifier hs-var">updateLoad</span></a></span><span> </span><span id="local-6989586621679080993"><span class="annot"><span class="annottext">m (Either e t)
</span><a href="#local-6989586621679080993"><span class="hs-identifier hs-var">_load</span></a></span></span><span> </span><span class="annot"><span class="annottext">e -&gt; m b
</span><span class="hs-identifier">_</span></span><span>  </span><span id="local-6989586621679080994"><span class="annot"><span class="annottext">t -&gt; da -&gt; m b
</span><a href="#local-6989586621679080994"><span class="hs-identifier hs-var">update'</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679080995"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679080995"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679080996"><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679080996"><span class="hs-identifier hs-var">da</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t -&gt; da -&gt; m b
</span><a href="#local-6989586621679080994"><span class="hs-identifier hs-var">update'</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679080995"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">da
</span><a href="#local-6989586621679080996"><span class="hs-identifier hs-var">da</span></a></span><span>
</span><span id="line-662"></span><span>
</span><span id="line-663"></span><span class="annot"><span class="hs-comment">-- | Throw 'Left' as an exception in the monad.</span></span><span>
</span><span id="line-664"></span><span id="local-6989586621679080437"><span id="local-6989586621679080438"><span class="annot"><a href="Data.Store.html#throwLeft"><span class="hs-identifier hs-type">throwLeft</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621679080437"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span> </span><span class="annot"><a href="#local-6989586621679080438"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080437"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080438"><span class="hs-identifier hs-type">b</span></a></span></span></span><span>
</span><span id="line-665"></span><span id="throwLeft"><span class="annot"><span class="annottext">throwLeft :: forall (m :: * -&gt; *) b.
MonadThrow m =&gt;
Either SomeException b -&gt; m b
</span><a href="Data.Store.html#throwLeft"><span class="hs-identifier hs-var hs-var">throwLeft</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-666"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span> </span><span id="local-6989586621679081006"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679081006"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">e -&gt; m b
forall e a. Exception e =&gt; e -&gt; m a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679081006"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-667"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679081007"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679081007"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">b -&gt; m b
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679081007"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-668"></span><span>
</span><span id="line-669"></span><span class="hs-comment">-- | Helper for implementing `updateS`.</span><span>
</span><span id="line-670"></span><span class="hs-comment">-- Call 'loadS' from a 'Store' if the value is not already given in memory.</span><span>
</span><span id="line-671"></span><span id="local-6989586621679080580"><span id="local-6989586621679080581"><span id="local-6989586621679080582"><span class="annot"><a href="Data.Store.html#loadWhenNothing"><span class="hs-identifier hs-type">loadWhenNothing</span></a></span><span>
</span><span id="line-672"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679080580"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadThrow</span></span><span> </span><span class="annot"><a href="#local-6989586621679080580"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Delta</span></span><span> </span><span class="annot"><a href="#local-6989586621679080581"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-673"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Base</span></span><span> </span><span class="annot"><a href="#local-6989586621679080581"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Data.Store.html#Store"><span class="hs-identifier hs-type">Store</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080580"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080582"><span class="hs-identifier hs-type">qa</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080581"><span class="hs-identifier hs-type">da</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080580"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Base</span></span><span> </span><span class="annot"><a href="#local-6989586621679080581"><span class="hs-identifier hs-type">da</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-674"></span><span id="loadWhenNothing"><span class="annot"><span class="annottext">loadWhenNothing :: forall (m :: * -&gt; *) da (qa :: * -&gt; *).
(Monad m, MonadThrow m, Delta da) =&gt;
Maybe (Base da) -&gt; Store m qa da -&gt; m (Base da)
</span><a href="Data.Store.html#loadWhenNothing"><span class="hs-identifier hs-var hs-var">loadWhenNothing</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679081015"><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679081015"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Store m qa da
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Base da -&gt; m (Base da)
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Base da
</span><a href="#local-6989586621679081015"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-675"></span><span class="annot"><a href="Data.Store.html#loadWhenNothing"><span class="hs-identifier hs-var">loadWhenNothing</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Base da)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span id="local-6989586621679081016"><span class="annot"><span class="annottext">Store m qa da
</span><a href="#local-6989586621679081016"><span class="hs-identifier hs-var">store</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Store m qa da -&gt; m (Either SomeException (Base da))
forall (m :: * -&gt; *) (qa :: * -&gt; *) da.
Store m qa da -&gt; m (Either SomeException (Base da))
</span><a href="Data.Store.html#loadS"><span class="hs-identifier hs-var">loadS</span></a></span><span> </span><span class="annot"><span class="annottext">Store m qa da
</span><a href="#local-6989586621679081016"><span class="hs-identifier hs-var">store</span></a></span><span> </span><span class="annot"><span class="annottext">m (Either SomeException (Base da))
-&gt; (Either SomeException (Base da) -&gt; m (Base da)) -&gt; m (Base da)
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Either SomeException (Base da) -&gt; m (Base da)
forall (m :: * -&gt; *) b.
MonadThrow m =&gt;
Either SomeException b -&gt; m b
</span><a href="Data.Store.html#throwLeft"><span class="hs-identifier hs-var">throwLeft</span></a></span><span>
</span><span id="line-676"></span><span>
</span><span id="line-677"></span><span id="local-6989586621679080586"><span id="local-6989586621679080587"><span class="annot"><a href="Data.Store.html#updateSequence"><span class="hs-identifier hs-type">updateSequence</span></a></span><span>
</span><span id="line-678"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679080586"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Delta</span></span><span> </span><span class="annot"><a href="#local-6989586621679080587"><span class="hs-identifier hs-type">delta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-679"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Base</span></span><span> </span><span class="annot"><a href="#local-6989586621679080587"><span class="hs-identifier hs-type">delta</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080587"><span class="hs-identifier hs-type">delta</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080586"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-680"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Base</span></span><span> </span><span class="annot"><a href="#local-6989586621679080587"><span class="hs-identifier hs-type">delta</span></a></span><span>
</span><span id="line-681"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679080587"><span class="hs-identifier hs-type">delta</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-682"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080586"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-683"></span><span id="updateSequence"><span class="annot"><span class="annottext">updateSequence :: forall (m :: * -&gt; *) delta.
(Monad m, Delta delta) =&gt;
(Base delta -&gt; delta -&gt; m ()) -&gt; Base delta -&gt; [delta] -&gt; m ()
</span><a href="Data.Store.html#updateSequence"><span class="hs-identifier hs-var hs-var">updateSequence</span></a></span></span><span> </span><span id="local-6989586621679081026"><span class="annot"><span class="annottext">Base delta -&gt; delta -&gt; m ()
</span><a href="#local-6989586621679081026"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679081027"><span class="annot"><span class="annottext">Base delta
</span><a href="#local-6989586621679081027"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Base delta -&gt; delta -&gt; m (Base delta))
-&gt; Base delta -&gt; [delta] -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">foldM_</span></span><span> </span><span class="annot"><span class="annottext">Base delta -&gt; delta -&gt; m (Base delta)
</span><a href="#local-6989586621679081028"><span class="hs-identifier hs-var">update'</span></a></span><span> </span><span class="annot"><span class="annottext">Base delta
</span><a href="#local-6989586621679081027"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">([delta] -&gt; m ()) -&gt; ([delta] -&gt; [delta]) -&gt; [delta] -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[delta] -&gt; [delta]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span>
</span><span id="line-684"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-685"></span><span>    </span><span id="local-6989586621679081028"><span class="annot"><span class="annottext">update' :: Base delta -&gt; delta -&gt; m (Base delta)
</span><a href="#local-6989586621679081028"><span class="hs-identifier hs-var hs-var">update'</span></a></span></span><span> </span><span id="local-6989586621679081030"><span class="annot"><span class="annottext">Base delta
</span><a href="#local-6989586621679081030"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span id="local-6989586621679081031"><span class="annot"><span class="annottext">delta
</span><a href="#local-6989586621679081031"><span class="hs-identifier hs-var">da</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Base delta -&gt; delta -&gt; m ()
</span><a href="#local-6989586621679081026"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Base delta
</span><a href="#local-6989586621679081030"><span class="hs-identifier hs-var">s'</span></a></span><span> </span><span class="annot"><span class="annottext">delta
</span><a href="#local-6989586621679081031"><span class="hs-identifier hs-var">da</span></a></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m (Base delta) -&gt; m (Base delta)
forall a b. m a -&gt; m b -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Base delta -&gt; m (Base delta)
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">delta
</span><a href="#local-6989586621679081031"><span class="hs-identifier hs-var">da</span></a></span><span> </span><span class="annot"><span class="annottext">delta -&gt; Base delta -&gt; Base delta
forall delta. Delta delta =&gt; delta -&gt; Base delta -&gt; Base delta
</span><span class="hs-operator hs-var">`apply`</span></span><span> </span><span class="annot"><span class="annottext">Base delta
</span><a href="#local-6989586621679081030"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-686"></span></pre></body></html>